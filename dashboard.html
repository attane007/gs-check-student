<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ระบบเช็คชื่อนักเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            pink: '#FFB3BA',
                            peach: '#FFDFBA',
                            yellow: '#FFFFBA',
                            green: '#BAFFC9',
                            blue: '#BAE1FF',
                            purple: '#E1BAFF',
                            lavender: '#F0E6FF',
                            mint: '#E6FFE6',
                            coral: '#FFE6E6',
                            sky: '#E6F3FF'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
        }
        .glass-effect {
            /* backdrop-filter: blur(10px); */ /* Removed for performance */
            background-color: rgba(255, 255, 255, 0.85); /* Slightly more opaque */
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .blur-backdrop {
            backdrop-filter: blur(10px);
        }
        .simple-hover:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pastel-blue via-pastel-sky to-pastel-mint">
    <!-- Header -->
    <header class="glass-effect blur-backdrop border-b border-white/20 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-pastel-purple to-pastel-blue rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-pie text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Dashboard สรุปผล</h1>
                        <p class="text-sm text-gray-600" id="currentDateTime"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="#" 
                       id="navIndexLink"
                       onclick="navigateTo('index')" 
                       class="px-4 py-2 rounded-lg font-semibold bg-white/50 text-gray-600 hover:bg-white/70">
                        <i class="fas fa-check-circle mr-1"></i>
                        ไปหน้าเช็คชื่อ
                    </a>
                    <div id="userInfoDisplay" class="text-sm text-gray-700"></div>
                    <button 
                        id="logoutButton"
                        class="px-4 py-2 rounded-lg font-semibold bg-pastel-coral text-gray-800 hover:opacity-90 hidden"
                    >
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        ออกจากระบบ
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Attendance Overview -->
                <div class="glass-effect rounded-2xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-pie text-pastel-purple mr-3"></i>
                        ภาพรวมการเข้าเรียนวันนี้
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-pastel-green to-pastel-mint rounded-xl p-4 text-center">
                            <i class="fas fa-user-check text-3xl text-gray-700 mb-2"></i>
                            <p class="text-2xl font-bold text-gray-800" id="dashTotalPresent">0</p>
                            <p class="text-sm text-gray-600">มาเรียน</p>
                        </div>
                        <div class="bg-gradient-to-r from-pastel-coral to-pastel-pink rounded-xl p-4 text-center">
                            <i class="fas fa-user-times text-3xl text-gray-700 mb-2"></i>
                            <p class="text-2xl font-bold text-gray-800" id="dashTotalAbsent">0</p>
                            <p class="text-sm text-gray-600">ขาดเรียน</p>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span>อัตราการเข้าเรียน</span>
                            <span id="dashAttendanceRate" class="font-semibold">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="dashAttendanceBar" class="bg-gradient-to-r from-pastel-green to-pastel-mint h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Classroom Statistics -->
                <div class="glass-effect rounded-2xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chalkboard-teacher text-pastel-purple mr-3"></i>
                        สถิติแยกตามห้องเรียน (วันนี้)
                    </h2>
                    <div id="classroomStatsToday" class="space-y-4 max-h-60 overflow-y-auto">
                        <p class="text-gray-600 text-center py-8">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>
                
                <!-- Overall Classroom Statistics -->
                <div class="glass-effect rounded-2xl p-8 lg:col-span-2">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-calendar-alt text-pastel-purple mr-3"></i>
                        สถิติห้องเรียน (ภาพรวม)
                    </h2>
                     <div class="mb-4 flex space-x-2">
                        <input type="date" id="dateFrom" class="p-2 border rounded-lg">
                        <input type="date" id="dateTo" class="p-2 border rounded-lg">
                        <button onclick="loadOverallDashboardDataWithToken()" class="bg-pastel-blue text-white px-4 py-2 rounded-lg">โหลดข้อมูล</button>
                    </div>
                    <div id="overallClassroomStats" class="space-y-4 max-h-96 overflow-y-auto">
                        <p class="text-gray-600 text-center py-8">เลือกช่วงวันที่เพื่อดูข้อมูล</p>
                    </div>
                </div>

                <!-- Top Attendees (Overall) -->
                <div class="glass-effect rounded-2xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-trophy text-pastel-purple mr-3"></i>
                        นักเรียนที่มาเรียนสม่ำเสมอ (ภาพรวม)
                    </h2>
                    <div id="topOverallAttendees" class="space-y-3 max-h-60 overflow-y-auto">
                        <p class="text-gray-600 text-center py-8">เลือกช่วงวันที่เพื่อดูข้อมูล</p>
                    </div>
                </div>
                 <!-- Daily Stats (Last 7 days) -->
                <div class="glass-effect rounded-2xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-calendar-day text-pastel-purple mr-3"></i>
                        สถิติรายวัน (7 วันล่าสุด)
                    </h2>
                    <div id="dailyStatsChartContainer" class="space-y-3">
                        <canvas id="dailyAttendanceChart" class="max-h-60"></canvas>
                        <p id="dailyStatsFallback" class="text-gray-600 text-center py-8 hidden">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-effect blur-backdrop rounded-2xl p-8 m-4 max-w-md w-full text-center">
            <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-300 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-white text-3xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">เกิดข้อผิดพลาด</h3>
            <div id="errorContent" class="text-gray-700"></div>
            <button onclick="closeModalAndMaybeLogout()" class="mt-6 bg-gradient-to-r from-pastel-coral to-pastel-pink text-gray-800 font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                ปิด
            </button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const appUrl = '<?!= appUrl ?>'; // Injected by Apps Script doGet
        let currentUser = null;
        let currentToken = null;

        // Helper function for top-level navigation in Apps Script
        function triggerTopNavigation(url) {
            const a = document.createElement('a');
            a.href = url;
            a.target = '_top'; // Ensures navigation of the top-level window
            document.body.appendChild(a); // Link must be in the document to be clicked
            a.click();
            document.body.removeChild(a); // Clean up the temporary link
        }

        document.addEventListener('DOMContentLoaded', function() {
            currentToken = localStorage.getItem('jwtToken');
            const storedUserInfo = localStorage.getItem('userInfo');

            if (!currentToken) {
                redirectToLogin('Session not found. Please login.');
                return;
            }

            if (storedUserInfo) {
                currentUser = JSON.parse(storedUserInfo);
                // Security check: Ensure only admin/teacher can access dashboard
                if (currentUser.role !== 'admin' && currentUser.role !== 'teacher') {
                    redirectToLogin('Access Denied: You do not have permission to view the dashboard.', 'index'); // Redirect to index page
                    return;
                }
                initializeDashboard();
            } else {
                // If token exists but no user info, try to fetch it
                setLoadingState(true, 'Verifying session...');
                google.script.run
                    .withSuccessHandler(function(response) {
                        setLoadingState(false);
                        if (response.success && response.user) {
                            currentUser = response.user;
                            localStorage.setItem('userInfo', JSON.stringify(currentUser));
                            if (currentUser.role !== 'admin' && currentUser.role !== 'teacher') {
                                redirectToLogin('Access Denied: You do not have permission to view the dashboard.', 'index');
                                return;
                            }
                            initializeDashboard();
                        } else {
                            handleAuthError(response.error || 'Invalid session. Please login again.', response.expired);
                        }
                    })
                    .withFailureHandler(function(error) {
                        setLoadingState(false);
                        handleAuthError('Error verifying session: ' + error.message);
                    })
                    .getUserDataFromToken(currentToken);
            }
        });

        function initializeDashboard() {
            if (!currentUser) {
                redirectToLogin('User data not available. Please login.');
                return;
            }
            console.log('Dashboard User:', currentUser.username, 'Role:', currentUser.role);
            updateUserInfoDisplay();
            setupLogoutButton();
            setupNavigation();
            loadOverallDashboardDataWithToken(); // Initial data load for dashboard
            loadDailyStatsChartData();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }

        function updateUserInfoDisplay() {
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            if (userInfoDisplay && currentUser) {
                userInfoDisplay.textContent = `Welcome, ${currentUser.fullName} (${currentUser.role})`;
            }
        }

        function setupLogoutButton() {
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.classList.remove('hidden');
                logoutButton.addEventListener('click', function() {
                    setLoadingState(true, 'Logging out...');
                    google.script.run
                        .withSuccessHandler(function(response) {
                            localStorage.removeItem('jwtToken');
                            localStorage.removeItem('userInfo');
                            redirectToLogin('You have been logged out.');
                        })
                        .withFailureHandler(function(error) {
                            localStorage.removeItem('jwtToken');
                            localStorage.removeItem('userInfo');
                            redirectToLogin('Logout completed. Server notification failed.');
                        })
                        .logoutUser(currentToken);
                });
            }
        }

        function setupNavigation() {
            const navIndexLink = document.getElementById('navIndexLink');
            if (navIndexLink) {
                navIndexLink.onclick = function(e) { e.preventDefault(); navigateTo('index'); };
            }
            // No dashboard link needed on dashboard page itself, or handle differently
        }

        function navigateTo(page) {
            // window.top.location.href = appUrl + '?page=' + page;
            triggerTopNavigation(appUrl + '?page=' + page);
        }

        function redirectToLogin(message, defaultPage = 'login') {
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userInfo');
            let targetUrl = appUrl + '?page=' + defaultPage;
            if (message) {
                if (defaultPage === 'login') {
                     targetUrl += (message.toLowerCase().includes('denied') || message.toLowerCase().includes('error') ? '&errorMessage=' : '&infoMessage=') + encodeURIComponent(message);
                } else {
                    targetUrl += '&infoMessage=' + encodeURIComponent(message); 
                }
            }
            // window.top.location.href = targetUrl;
            triggerTopNavigation(targetUrl);
        }

        function handleAuthError(errorMessage, isExpired) {
            console.error('Auth Error:', errorMessage);
            showErrorModal('Authentication Error: ' + errorMessage + (isExpired ? ' (Token Expired)' : ''), true);
        }

        function setLoadingState(isLoading, message = 'Loading...') {
            // A more generic loading indicator might be needed for the dashboard
            // For now, we can log or use a simple visual cue if one exists
            console.log(isLoading ? `Loading: ${message}` : 'Loading complete.');
            // Example: If you have a global loading overlay
            // const overlay = document.getElementById('globalLoadingOverlay');
            // if (overlay) overlay.classList.toggle('hidden', !isLoading);
        }

        function loadOverallDashboardDataWithToken() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            setLoadingState(true, 'Loading dashboard data...');
            google.script.run
                .withSuccessHandler(function(response) {
                    setLoadingState(false);
                    if (response.success) {
                        updateDashboardUI(response.stats); 
                        updateClassroomStatsToday(response.todayClassroomStats); 
                        updateTopAttendees(response.topAttendees); 
                    } else {
                        handleAuthError(response.error || 'Failed to load dashboard data.', response.expired);
                    }
                })
                .withFailureHandler(function(error) {
                    setLoadingState(false);
                    handleAuthError('Error loading dashboard data: ' + error.message);
                })
                .getDashboardData(dateFrom, dateTo, currentToken); // New Code.gs function needed
        }

        function updateDashboardUI(stats) {
            if (!stats) return;
            document.getElementById('dashTotalPresent').textContent = stats.totalPresentToday || 0;
            document.getElementById('dashTotalAbsent').textContent = stats.totalAbsentToday || 0;
            const rate = stats.overallAttendanceRateToday || 0;
            document.getElementById('dashAttendanceRate').textContent = `${rate.toFixed(1)}%`;
            document.getElementById('dashAttendanceBar').style.width = `${rate}%`;
            
            // For overall classroom stats (if part of the same response or separate)
            const overallStatsContainer = document.getElementById('overallClassroomStats');
            overallStatsContainer.innerHTML = ''; // Clear
            if (stats.overallClassroomBreakdown && stats.overallClassroomBreakdown.length > 0) {
                stats.overallClassroomBreakdown.forEach(cls => {
                    const p = document.createElement('p');
                    p.textContent = `${cls.name}: Present ${cls.present}, Absent ${cls.absent} (Rate: ${cls.rate.toFixed(1)}%)`;
                    overallStatsContainer.appendChild(p);
                });
            } else {
                overallStatsContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No overall data for selected period.</p>';
            }
        }

        function updateClassroomStatsToday(classroomStats) {
            const container = document.getElementById('classroomStatsToday');
            container.innerHTML = ''; // Clear
            if (classroomStats && classroomStats.length > 0) {
                classroomStats.forEach(stat => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-white/70 rounded-lg';
                    div.innerHTML = `
                        <h4 class="font-semibold text-gray-700">${stat.classroomName}</h4>
                        <div class="flex justify-between text-sm">
                            <span>Present: <strong class="text-green-600">${stat.present}</strong></span>
                            <span>Absent: <strong class="text-red-600">${stat.absent}</strong></span>
                            <span>Rate: <strong>${stat.rate.toFixed(1)}%</strong></span>
                        </div>`;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<p class="text-gray-600 text-center py-4">No classroom attendance recorded today.</p>';
            }
        }
        
        function updateTopAttendees(attendees) {
            const container = document.getElementById('topOverallAttendees');
            container.innerHTML = ''; // Clear
            if (attendees && attendees.length > 0) {
                attendees.forEach(att => {
                    const p = document.createElement('p');
                    p.className = 'text-sm text-gray-700';
                    p.innerHTML = `<strong>${att.studentName}</strong>: ${att.daysPresent} days present`;
                    container.appendChild(p);
                });
            } else {
                container.innerHTML = '<p class="text-gray-600 text-center py-4">No top attendee data for selected period.</p>';
            }
        }

        function loadDailyStatsChartData() {
            setLoadingState(true, 'Loading daily chart...');
            google.script.run
                .withSuccessHandler(function(response){
                    setLoadingState(false);
                    if(response.success && response.dailyStats){
                        renderDailyAttendanceChart(response.dailyStats);
                        document.getElementById('dailyStatsFallback').classList.add('hidden');
                    } else {
                        document.getElementById('dailyStatsFallback').textContent = response.error || 'Could not load chart data.';
                        document.getElementById('dailyStatsFallback').classList.remove('hidden');
                        if(!response.success) handleAuthError(response.error, response.expired);
                    }
                })
                .withFailureHandler(function(err){
                    setLoadingState(false);
                    document.getElementById('dailyStatsFallback').textContent = 'Error loading chart: ' + err.message;
                    document.getElementById('dailyStatsFallback').classList.remove('hidden');
                    handleAuthError('Error loading chart: ' + err.message);
                })
                .getDailyAttendanceStats(7, currentToken); // Get stats for last 7 days
        }

        var dailyChartInstance = null; // To keep track of the chart instance
        function renderDailyAttendanceChart(dailyData) {
            const ctx = document.getElementById('dailyAttendanceChart').getContext('2d');
            if (dailyChartInstance) {
                dailyChartInstance.destroy(); // Destroy previous chart instance if exists
            }
            const labels = dailyData.map(d => new Date(d.date).toLocaleDateString('th-TH', { month: 'short', day: 'numeric' }));
            const presentData = dailyData.map(d => d.present);
            const absentData = dailyData.map(d => d.absent);

            dailyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'มาเรียน',
                            data: presentData,
                            backgroundColor: 'rgba(75, 192, 192, 0.5)', // Pastel Green
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ขาดเรียน',
                            data: absentData,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)', // Pastel Red
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('th-TH', options);
        }

        // --- Error Modal --- (Shared with index.html, ensure it's defined or include if separate)
        function showErrorModal(message, isAuthError = false) {
            document.getElementById('errorContent').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
            const closeButton = document.getElementById('errorModal').querySelector('button');
            if (isAuthError) {
                closeButton.onclick = function() { closeModalAndLogout(); };
            } else {
                closeButton.onclick = function() { closeModal(); };
            }
        }

        function closeModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        function closeModalAndMaybeLogout() { // Renamed to be more specific
            closeModal();
            // This function is called from the modal. If it was an auth error, it should trigger logout.
            // The logic in showErrorModal sets the button's onclick to closeModalAndLogout if isAuthError is true.
            // So, if we reach here via that path, we should log out.
            // We need a way to know if this specific modal instance was for an auth error.
            // The simplest is to rely on the onclick being set correctly by showErrorModal.
            // If the button was set to call this, and it was an auth error, then proceed to logout.
            const isLikelyAuthError = document.getElementById('errorContent').textContent.toLowerCase().includes('authentication') || document.getElementById('errorContent').textContent.toLowerCase().includes('session');
            const isExpiredToken = document.getElementById('errorContent').textContent.toLowerCase().includes('token expired');
            if(isLikelyAuthError || isExpiredToken){
                redirectToLogin('Your session is no longer valid. Please login again.');
            }
        }

        // Assumed new Code.gs functions:
        // google.script.run.getDashboardData(dateFrom, dateTo, currentToken);
        // google.script.run.getDailyAttendanceStats(days, currentToken);

    </script>
</body>
</html>
