<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ระบบเช็คชื่อการเข้าแถวตอนเช้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            pink: '#FFB3BA',
                            peach: '#FFDFBA',
                            yellow: '#FFFFBA',
                            green: '#BAFFC9',
                            blue: '#BAE1FF',
                            purple: '#E1BAFF',
                            lavender: '#F0E6FF',
                            mint: '#E6FFE6',
                            coral: '#FFE6E6',
                            sky: '#E6F3FF'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
        }
        .glass-effect {
            /* backdrop-filter: blur(10px); */ /* Removed for performance */
            background-color: rgba(255, 255, 255, 0.85); /* Slightly more opaque */
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .blur-backdrop {
            backdrop-filter: blur(10px);
        }
        .simple-hover:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pastel-purple via-pastel-blue to-pastel-sky">
    <!-- Authentication Message Area -->
    <div id="authMessageArea" class="hidden fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center p-8 bg-white shadow-lg rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Authentication Required</h2>
            <p id="authMessageText" class="text-gray-600 mb-6">You need to be logged in to access this page.</p>
            <a id="authLoginLink" href="#" class="bg-pastel-purple text-white font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                Go to Login
            </a>
        </div>
    </div>
      <!-- Header -->
    <header class="glass-effect blur-backdrop border-b border-white/20 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-pastel-purple to-pastel-blue rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-pie text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Dashboard สรุปผล</h1>
                        <p class="text-sm text-gray-600" id="currentDateTime"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">                    <!-- Navigation -->
                    <div class="flex space-x-2">
                        <a 
                            href="#" 
                            id="navIndexLink"
                            onclick="navigateTo('index')" 
                            class="px-4 py-2 rounded-lg font-semibold bg-white/50 text-gray-600 hover:bg-white/70"
                        >
                            <i class="fas fa-check-circle mr-1"></i>
                            เช็คชื่อ
                        </a>
                        <a 
                            href="#" 
                            id="navDashboardLink"
                            onclick="navigateTo('dashboard')" 
                            class="px-4 py-2 rounded-lg font-semibold bg-pastel-green text-gray-800"
                        >
                            <i class="fas fa-chart-pie mr-1"></i>
                            Dashboard
                        </a>
                        <a 
                            href="#" 
                            id="navSearchLink"
                            onclick="navigateTo('search')" 
                            class="px-4 py-2 rounded-lg font-semibold bg-white/50 text-gray-600 hover:bg-white/70 hidden"
                        >
                            <i class="fas fa-search mr-1"></i>
                            ค้นหา
                        </a>
                    </div>
                    <div id="userInfoDisplay" class="text-sm text-gray-700"></div>
                    <button 
                        id="logoutButton"
                        class="px-4 py-2 rounded-lg font-semibold bg-pastel-coral text-gray-800 hover:opacity-90 hidden"
                    >
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        ออกจากระบบ
                    </button>
                </div>
            </div>
        </div>
    </header><div class="container mx-auto px-4 py-8">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50">
                <div class="glass-effect rounded-xl p-8 text-center">
                    <div class="mb-4 relative">
                        <div class="w-16 h-16 border-4 border-pastel-purple border-t-transparent rounded-full animate-spin mx-auto"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-chart-bar text-pastel-purple text-sm"></i>
                        </div>
                    </div>
                    <p id="loadingMessage" class="text-lg font-medium text-gray-700">กำลังประมวลผล...</p>
                    <p class="text-sm text-gray-500 mt-1">โปรดรอสักครู่</p>
                </div>
            </div>
            
            <!-- Main Grid Layout -->
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Attendance Overview -->
                <div class="glass-effect rounded-2xl p-8 simple-hover shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-pie text-pastel-purple mr-3"></i>
                        ภาพรวมการเข้าแถววันนี้
                    </h2>
                      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <!-- Present Card -->
                        <div class="bg-gradient-to-r from-pastel-green to-pastel-mint rounded-xl p-4 text-center shadow-lg transform transition-all duration-300 hover:scale-105 border border-white/50 relative overflow-hidden">
                            <div class="absolute -top-6 -right-6 w-24 h-24 bg-white/20 rounded-full"></div>
                            <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white/10 rounded-full"></div>
                            <div class="w-16 h-16 mx-auto mb-2 bg-white/30 rounded-full flex items-center justify-center shadow-inner">
                                <i class="fas fa-user-check text-green-700 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-gray-800" id="dashPresentCount">0</p>
                            <p class="text-sm font-medium text-gray-800 mt-1">เข้าแถว</p>
                        </div>
                        
                        <!-- Absent Card -->
                        <div class="bg-gradient-to-r from-pastel-coral to-pastel-pink rounded-xl p-4 text-center shadow-lg transform transition-all duration-300 hover:scale-105 border border-white/50 relative overflow-hidden">
                            <div class="absolute -top-6 -right-6 w-24 h-24 bg-white/20 rounded-full"></div>
                            <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white/10 rounded-full"></div>
                            <div class="w-16 h-16 mx-auto mb-2 bg-white/30 rounded-full flex items-center justify-center shadow-inner">
                                <i class="fas fa-user-times text-red-700 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-gray-800" id="dashTotalAbsent">0</p>
                            <p class="text-sm font-medium text-gray-800 mt-1">ไม่เข้าแถว</p>
                        </div>
                          <!-- Late Card -->
                        <div class="bg-gradient-to-r from-pastel-yellow to-pastel-peach rounded-xl p-4 text-center shadow-lg transform transition-all duration-300 hover:scale-105 border border-white/50 relative overflow-hidden">
                            <div class="absolute -top-6 -right-6 w-24 h-24 bg-white/20 rounded-full"></div>
                            <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white/10 rounded-full"></div>
                            <div class="w-16 h-16 mx-auto mb-2 bg-white/30 rounded-full flex items-center justify-center shadow-inner">
                                <i class="fas fa-clock text-yellow-700 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-gray-800" id="dashLateCount">0</p>
                            <p class="text-sm font-medium text-gray-800 mt-1">มาสาย</p>
                        </div>
                        
                        <!-- Excused Card -->
                        <div class="bg-gradient-to-r from-pastel-blue to-pastel-sky rounded-xl p-4 text-center shadow-lg transform transition-all duration-300 hover:scale-105 border border-white/50 relative overflow-hidden">
                            <div class="absolute -top-6 -right-6 w-24 h-24 bg-white/20 rounded-full"></div>
                            <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white/10 rounded-full"></div>
                            <div class="w-16 h-16 mx-auto mb-2 bg-white/30 rounded-full flex items-center justify-center shadow-inner">
                                <i class="fas fa-calendar-minus text-blue-700 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-gray-800" id="dashExcusedCount">0</p>
                            <p class="text-sm font-medium text-gray-800 mt-1">ลา</p>
                        </div>
                    </div>                    <div class="bg-white/70 rounded-xl p-4 shadow-md border border-white/50">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-gradient-to-r from-pastel-purple to-pastel-blue rounded-full flex items-center justify-center mr-2 shadow-sm">
                                    <i class="fas fa-percentage text-white text-xs"></i>
                                </div>
                                <span class="font-medium text-gray-700">อัตราการเข้าแถว</span>
                            </div>
                            <span id="dashAttendanceRate" class="text-xl font-bold text-pastel-purple">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-5 shadow-inner relative overflow-hidden">
                            <div id="dashAttendanceBar" class="bg-gradient-to-r from-pastel-green to-pastel-mint h-5 rounded-full transition-all duration-500 flex items-center justify-end px-2" style="width: 0%">
                                <span class="text-xs font-bold text-white/90 drop-shadow-md" id="dashAttendanceBarText"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Classroom Statistics -->
                <div class="glass-effect rounded-2xl p-8 simple-hover shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chalkboard-teacher text-pastel-purple mr-3"></i>
                        สถิติแยกตามห้องเรียน (วันนี้)
                    </h2>
                    <div id="classroomStatsToday" class="space-y-4 max-h-60 overflow-y-auto pr-2">
                        <div class="flex flex-col items-center justify-center h-40">
                            <div class="w-16 h-16 mx-auto mb-3 bg-pastel-blue/30 rounded-full flex items-center justify-center animate-pulse">
                                <i class="fas fa-spinner fa-spin text-2xl text-pastel-purple"></i>
                            </div>
                            <p class="text-gray-600">กำลังโหลดข้อมูล...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Overall Classroom Statistics -->
                <div class="glass-effect rounded-2xl p-8 lg:col-span-2 simple-hover shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-calendar-alt text-pastel-purple mr-3"></i>
                        สถิติห้องเรียน (ภาพรวม)
                    </h2>                    <div class="mb-6 glass-effect p-5 rounded-xl flex flex-wrap md:flex-nowrap items-center gap-4 md:gap-6 shadow-md border border-white/30">
                        <div class="w-full md:w-auto">
                            <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-alt text-pastel-purple mr-2"></i>
                                วันที่เริ่มต้น
                            </label>
                            <input type="date" id="dateFrom" 
                                  class="p-3 border border-pastel-purple/40 rounded-lg w-full focus:ring-2 focus:ring-pastel-purple focus:outline-none shadow-sm bg-white/90 text-gray-700">
                        </div>
                        <div class="w-full md:w-auto">
                            <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-check text-pastel-purple mr-2"></i>
                                วันที่สิ้นสุด
                            </label>
                            <input type="date" id="dateTo" 
                                  class="p-3 border border-pastel-purple/40 rounded-lg w-full focus:ring-2 focus:ring-pastel-purple focus:outline-none shadow-sm bg-white/90 text-gray-700">
                        </div>
                        <div class="w-full md:w-auto flex items-end md:ml-auto">
                            <button onclick="loadOverallDashboardDataWithToken()" 
                                class="w-full md:w-auto bg-gradient-to-r from-pastel-blue to-pastel-purple text-white font-semibold px-7 py-3 rounded-xl hover:shadow-xl transition-all duration-200 shadow-md flex items-center justify-center transform hover:scale-105">
                                <i class="fas fa-sync-alt mr-2"></i>
                                โหลดข้อมูล
                            </button>
                        </div>
                    </div>                    <div id="overallClassroomStats" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <div class="flex flex-col items-center justify-center h-40 bg-white/60 rounded-xl p-6 border border-white/50 shadow-sm">
                            <div class="w-20 h-20 mx-auto mb-3 bg-gradient-to-r from-pastel-blue to-pastel-purple rounded-full flex items-center justify-center shadow-md">
                                <i class="fas fa-calendar-alt text-2xl text-white"></i>
                            </div>
                            <p class="text-gray-700 font-medium">เลือกช่วงวันที่เพื่อดูข้อมูล</p>
                            <p class="text-xs text-gray-500 mt-1">กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด แล้วกดปุ่ม "โหลดข้อมูล"</p>
                        </div>
                    </div>
                </div>

                <!-- Top Attendees (Overall) -->
                <div class="glass-effect rounded-2xl p-8 simple-hover shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-trophy text-pastel-purple mr-3"></i>
                        นักเรียนที่เข้าแถวสม่ำเสมอ
                    </h2>
                    <div id="topOverallAttendees" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <div class="flex flex-col items-center justify-center h-40">
                            <div class="w-16 h-16 mx-auto mb-3 bg-pastel-yellow/30 rounded-full flex items-center justify-center">
                                <i class="fas fa-medal text-2xl text-pastel-purple"></i>
                            </div>
                            <p class="text-gray-600">เลือกช่วงวันที่เพื่อดูข้อมูล</p>
                        </div>
                    </div>
                </div>
                  <!-- Daily Stats (Last 7 days) -->
                <div class="glass-effect rounded-2xl p-8 simple-hover shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-calendar-day text-pastel-purple mr-3"></i>
                        สถิติรายวัน (7 วันล่าสุด)
                    </h2>                    <div id="dailyStatsChartContainer" class="space-y-3">
                        <canvas id="dailyAttendanceChart" class="max-h-60"></canvas>
                        <p id="dailyStatsFallback" class="text-gray-600 text-center py-8 hidden">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-effect blur-backdrop rounded-2xl p-8 m-4 max-w-md w-full text-center">
            <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-300 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-white text-3xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">เกิดข้อผิดพลาด</h3>
            <div id="errorContent" class="text-gray-700"></div>
            <button onclick="closeModalAndMaybeLogout()" class="mt-6 bg-gradient-to-r from-pastel-coral to-pastel-pink text-gray-800 font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                ปิด
            </button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const appUrl = '<?!= appUrl ?>'; // Injected by Apps Script doGet
        let currentUser = null;
        let currentToken = null;

        // Helper function for top-level navigation in Apps Script
        function triggerTopNavigation(url) {
            const a = document.createElement('a');
            a.href = url;
            a.target = '_top'; // Ensures navigation of the top-level window
            document.body.appendChild(a); // Link must be in the document to be clicked
            a.click();
            document.body.removeChild(a); // Clean up the temporary link
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loading...');
            
            // Check that all critical UI elements are present
            const criticalElements = [
                'dashTotalPresent', 
                'dashTotalAbsent', 
                'dashAttendanceRate', 
                'dashAttendanceBar',
                'dashExcusedCount', // new for "ลา"
                'classroomStatsToday', 
                'overallClassroomStats', 
                'topOverallAttendees',
                'dailyAttendanceChart',
                'dailyStatsFallback',
                'dateFrom',
                'dateTo'
            ];
            
            let missingElements = criticalElements.filter(id => !document.getElementById(id));
            if (missingElements.length > 0) {
                console.error('Missing UI elements:', missingElements);
            }
            
            currentToken = localStorage.getItem('jwtToken');
            const storedUserInfo = localStorage.getItem('userInfo');

            if (!currentToken) {
                redirectToLogin('Session not found. Please login.');
                return;
            }

            if (storedUserInfo) {
                currentUser = JSON.parse(storedUserInfo);
                // Security check: Ensure only admin/teacher can access dashboard
                if (currentUser.role !== 'admin' && currentUser.role !== 'teacher') {
                    redirectToLogin('Access Denied: You do not have permission to view the dashboard.', 'index'); // Redirect to index page
                    return;
                }
                initializeDashboard();
            } else {
                // If token exists but no user info, try to fetch it
                setLoadingState(true, 'Verifying session...');
                google.script.run
                    .withSuccessHandler(function(response) {
                        setLoadingState(false);
                        if (response.success && response.user) {
                            currentUser = response.user;
                            localStorage.setItem('userInfo', JSON.stringify(currentUser));
                            if (currentUser.role !== 'admin' && currentUser.role !== 'teacher') {
                                redirectToLogin('Access Denied: You do not have permission to view the dashboard.', 'index');
                                return;
                            }
                            initializeDashboard();
                        } else {
                            handleAuthError(response.error || 'Invalid session. Please login again.', response.expired);
                        }
                    })
                    .withFailureHandler(function(error) {
                        setLoadingState(false);
                        handleAuthError('Error verifying session: ' + error.message);
                    })
                    .getUserDataFromToken(currentToken);
            }
        });
        
        function initializeDashboard() {
            if (!currentUser) {
                redirectToLogin('User data not available. Please login.');
                return;
            }
            console.log('Dashboard User:', currentUser.username, 'Role:', currentUser.role);
            
            // Set default dates for the date range selector
            const today = new Date();
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            document.getElementById('dateFrom').value = formatDateForInput(oneMonthAgo);
            document.getElementById('dateTo').value = formatDateForInput(today);
            
            updateUserInfoDisplay();
            setupLogoutButton();            setupNavigation();
            loadOverallDashboardDataWithToken(); // Initial data load for dashboard
            loadDailyStatsChartData();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }
        
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
        }

        function updateUserInfoDisplay() {
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            if (userInfoDisplay && currentUser) {
                userInfoDisplay.textContent = `Welcome, ${currentUser.fullName} (${currentUser.role})`;
            }
        }

        function setupLogoutButton() {
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.classList.remove('hidden');
                logoutButton.addEventListener('click', function() {
                    setLoadingState(true, 'Logging out...');
                    google.script.run
                        .withSuccessHandler(function(response) {
                            localStorage.removeItem('jwtToken');
                            localStorage.removeItem('userInfo');
                            redirectToLogin('You have been logged out.');
                        })
                        .withFailureHandler(function(error) {
                            localStorage.removeItem('jwtToken');
                            localStorage.removeItem('userInfo');
                            redirectToLogin('Logout completed. Server notification failed.');
                        })
                        .logoutUser(currentToken);
                });
            }
        }        function setupNavigation() {
            const navIndexLink = document.getElementById('navIndexLink');
            const navDashboardLink = document.getElementById('navDashboardLink');
            const navSearchLink = document.getElementById('navSearchLink');
            
            if (navIndexLink) {
                navIndexLink.onclick = function(e) { e.preventDefault(); navigateTo('index'); };
            }
            if (navDashboardLink) {
                navDashboardLink.onclick = function(e) { e.preventDefault(); navigateTo('dashboard'); };
            }
            if (navSearchLink) {
                navSearchLink.onclick = function(e) { e.preventDefault(); navigateTo('search'); };
                // Show search link only if admin/teacher
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'teacher')) {
                    navSearchLink.classList.remove('hidden'); 
                } else {
                    navSearchLink.classList.add('hidden');
                }
            }
            // Dashboard link is current page - no special handling needed
        }

        function navigateTo(page) {
            // window.top.location.href = appUrl + '?page=' + page;
            triggerTopNavigation(appUrl + '?page=' + page);
        }

        function redirectToLogin(message, defaultPage = 'login') {
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userInfo');
            let targetUrl = appUrl + '?page=' + defaultPage;
            if (message) {
                if (defaultPage === 'login') {
                     targetUrl += (message.toLowerCase().includes('denied') || message.toLowerCase().includes('error') ? '&errorMessage=' : '&infoMessage=') + encodeURIComponent(message);
                } else {
                    targetUrl += '&infoMessage=' + encodeURIComponent(message); 
                }
            }
            // window.top.location.href = targetUrl;
            triggerTopNavigation(targetUrl);
        }        function handleAuthError(errorMessage, isExpired) {
            console.error('Auth Error:', errorMessage);
            showErrorModal('Authentication Error: ' + errorMessage + (isExpired ? ' (Token Expired)' : ''), true);
        }
        
        function setLoadingState(isLoading, message = 'กำลังประมวลผล...') {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingMessage = document.getElementById('loadingMessage');
            
            if (!loadingIndicator || !loadingMessage) {
                console.warn('Loading indicator elements not found');
                console.log(`Loading state: ${isLoading ? 'Loading' : 'Done'} ${message}`);
                return;
            }
            
            if (isLoading) {
                loadingMessage.textContent = message;
                loadingIndicator.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // Prevent scrolling while loading
            } else {
                loadingIndicator.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
              console.log(`Loading state: ${isLoading ? 'Loading' : 'Done'} ${message}`);
        }
          function loadOverallDashboardDataWithToken() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            setLoadingState(true, 'Loading dashboard data...');
            console.log('Requesting dashboard data with token:', currentToken ? 'Token exists' : 'No token!');
            console.log('Date range for dashboard data:', { from: dateFrom, to: dateTo });
            
            google.script.run
                .withSuccessHandler(function(response) {
                    setLoadingState(false);
                    console.log('Dashboard data response:', response);
                              if (response.success) {
                        if (!response.stats) {
                            console.error('Dashboard data response is missing stats object');
                            showErrorModal('Dashboard data is incomplete. Please try again.');
                            return;
                        }
                        
                        // Debug log to see exactly what values we're getting
                        console.log('Dashboard attendance stats:', {
                            totalPresent: response.stats.totalPresentToday,
                            totalLate: response.stats.totalLateToday,
                            totalExcused: response.stats.totalExcusedToday,
                            totalAbsent: response.stats.totalAbsentToday,
                            total: (response.stats.totalPresentToday || 0) + 
                                  (response.stats.totalLateToday || 0) + 
                                  (response.stats.totalExcusedToday || 0) + 
                                  (response.stats.totalAbsentToday || 0)
                        });
                        
                        updateDashboardUI(response.stats);
                        
                        if (response.todayClassroomStats) {
                            updateClassroomStatsToday(response.todayClassroomStats);
                        } else {
                            console.warn('Missing todayClassroomStats in response');
                            updateClassroomStatsToday([]);
                        }
                        
                        if (response.stats.topAttendees) {
                            updateTopAttendees(response.stats.topAttendees);
                        } else {
                            console.warn('Missing topAttendees in response');
                            updateTopAttendees([]);
                        }
                    } else {
                        handleAuthError(response.error || 'Failed to load dashboard data.', response.expired);
                    }
                })
                .withFailureHandler(function(error) {
                    setLoadingState(false);
                    handleAuthError('Error loading dashboard data: ' + error.message);
                })                .getDashboardData(dateFrom, dateTo, currentToken);
        }
        
        function updateDashboardUI(stats) {
            if (!stats) return;            console.log('Updating dashboard UI with stats:', stats);
              // Update dashboard header count - the dashboard already includes late students in totalPresentToday count
            // We should NOT add them again to avoid double-counting
            const totalAttendingToday = stats.totalPresentToday || 0; // totalPresentToday already includes late students
            console.log('Total attending today:', totalAttendingToday, 
                '(Present:', stats.totalPresentToday, '+ Late:', stats.totalLateToday, 
                '- Note: Present already includes Late in backend calculation)');
            document.getElementById('dashTotalPresent').textContent = totalAttendingToday;
            
            // Update dashboard cards
            document.getElementById('dashPresentCount').textContent = stats.totalPresentToday || 0;
            document.getElementById('dashTotalAbsent').textContent = stats.totalAbsentToday || 0;
            document.getElementById('dashLateCount').textContent = stats.totalLateToday || 0;
            document.getElementById('dashExcusedCount').textContent = stats.totalExcusedToday || 0; // เพิ่มสถานะ "ลา"
            
            const rate = stats.overallAttendanceRateToday || 0;
            document.getElementById('dashAttendanceRate').textContent = `${rate.toFixed(1)}%`;
            
            // Also update the text inside the progress bar if the percentage is high enough to show it
            const attendanceBarText = document.getElementById('dashAttendanceBarText');
            if (rate >= 15) { // Only show text if bar is wide enough
                attendanceBarText.textContent = `${rate.toFixed(1)}%`;
                attendanceBarText.classList.remove('hidden');
            } else {
                attendanceBarText.classList.add('hidden');
            }
            
            // Animate progress bar for visual appeal
            document.getElementById('dashAttendanceBar').style.width = '0%';
            setTimeout(() => {
                document.getElementById('dashAttendanceBar').style.width = `${rate}%`;
            }, 200);
            
            // For overall classroom stats (if part of the same response or separate)
            const overallStatsContainer = document.getElementById('overallClassroomStats');
            overallStatsContainer.innerHTML = ''; // Clear
            
            if (stats.overallClassroomBreakdown && stats.overallClassroomBreakdown.length > 0) {
                stats.overallClassroomBreakdown.forEach(cls => {
                    const card = document.createElement('div');
                    card.className = 'bg-white/70 rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-300 mb-3';
                    
                    const rate = cls.rate !== undefined ? cls.rate : 
                               (cls.total > 0 ? ((cls.present || 0) / cls.total * 100) : 0);
                      card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg text-gray-800">${cls.name}</h4>
                            <span class="text-sm bg-pastel-purple/20 text-pastel-purple px-2 py-1 rounded-full">
                                ${rate.toFixed(1)}%
                            </span>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center">
                            <div>
                                <span class="text-xs text-gray-600">เข้าแถว</span>
                                <p class="font-semibold text-green-600">${cls.present || 0}</p>
                            </div>
                            <div>
                                <span class="text-xs text-gray-600">สาย</span>
                                <p class="font-semibold text-yellow-600">${cls.late || 0}</p>
                            </div>
                            <div>
                                <span class="text-xs text-gray-600">ลา</span>
                                <p class="font-semibold text-blue-600">${cls.excused || 0}</p>
                            </div>
                            <div>
                                <span class="text-xs text-gray-600">ขาด</span>
                                <p class="font-semibold text-red-600">${cls.absent || 0}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-xs text-gray-600">
                            <span>รวมทั้งหมด: <span class="font-semibold">${cls.total || 0}</span></span>
                            <span>อัตราเข้าแถว: <span class="font-semibold">${rate.toFixed(1)}%</span></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-gradient-to-r from-pastel-green to-pastel-mint h-2 rounded-full" 
                                 style="width: ${rate}%"></div>
                        </div>
                    `;
                    overallStatsContainer.appendChild(card);
                });
            } else {
                overallStatsContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40">
                        <div class="w-16 h-16 mx-auto mb-3 bg-pastel-blue/30 rounded-full flex items-center justify-center">
                            <i class="fas fa-info-circle text-2xl text-pastel-purple"></i>
                        </div>
                        <p class="text-gray-600">ไม่พบข้อมูลสำหรับช่วงเวลาที่เลือก</p>                    </div>
                `;
            }
        }
        
        function updateClassroomStatsToday(classroomStats) {
            const container = document.getElementById('classroomStatsToday');
            container.innerHTML = ''; // Clear
            
            console.log('Updating classroom stats with:', classroomStats);
            
            if (!classroomStats) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40">
                        <div class="w-16 h-16 mx-auto mb-3 bg-pastel-blue/30 rounded-full flex items-center justify-center">
                            <i class="fas fa-info-circle text-2xl text-pastel-purple"></i>
                        </div>
                        <p class="text-gray-600">ไม่พบข้อมูลห้องเรียนสำหรับวันนี้</p>
                    </div>
                `;
                return;
            }
            
            if (classroomStats.length > 0) {
                // Create a search box for classrooms
                const searchBox = document.createElement('div');
                searchBox.className = 'mb-4 relative';
                searchBox.innerHTML = `
                    <input 
                        id="classroomSearch" 
                        type="text" 
                        placeholder="ค้นหาห้องเรียน..." 
                        class="w-full px-4 py-3 pr-10 border-2 border-pastel-blue/20 rounded-xl focus:border-pastel-purple focus:outline-none bg-white/80"
                        oninput="filterClassrooms()"
                    >
                    <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                        <i class="fas fa-search"></i>
                    </span>
                `;
                container.appendChild(searchBox);
                
                const statsContainer = document.createElement('div');
                statsContainer.id = 'classroomStatsList';
                statsContainer.className = 'space-y-3';
                container.appendChild(statsContainer);
                
                classroomStats.forEach(stat => {
                    try {
                        const div = document.createElement('div');                        div.className = 'classroom-stat-card bg-white/80 rounded-xl p-4 shadow-md hover:bg-white transition-all duration-200';
                          // Handle different possible property names
                        const name = stat.classroomName || stat.name || 'Unknown Classroom';
                        const present = stat.present || 0;
                        const absent = stat.absent || 0;
                        const late = stat.late || 0;
                        const excused = stat.excused || 0; // เพิ่มสถานะ "ลา"
                        const total = stat.total || (present + absent + late + excused);
                        // Calculate rate if not provided, or use the provided rate
                        const rate = stat.rate !== undefined ? stat.rate : 
                                    (total > 0 ? ((present + late) / total * 100) : 0);
                        
                        // Determine a color theme based on attendance rate
                        let colorTheme;
                        if (rate >= 90) {
                            colorTheme = 'from-pastel-green to-pastel-mint';
                        } else if (rate >= 70) {
                            colorTheme = 'from-pastel-blue to-pastel-sky';
                        } else if (rate >= 50) {
                            colorTheme = 'from-pastel-yellow to-pastel-peach';
                        } else {
                            colorTheme = 'from-pastel-coral to-pastel-pink';
                        }
                        
                        div.innerHTML = `
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 bg-gradient-to-r ${colorTheme} rounded-full flex items-center justify-center mr-3 shadow-sm">
                                    <i class="fas fa-chalkboard-teacher text-white"></i>
                                </div>
                                <h4 class="font-bold text-lg text-gray-800">${name}</h4>
                            </div>                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-3">
                                <div class="bg-gradient-to-r from-pastel-green to-pastel-mint rounded-lg p-2 text-center shadow-sm">
                                    <div class="text-lg font-bold text-gray-800">${present}</div>
                                    <div class="text-xs text-gray-700">เข้าแถว</div>
                                </div>
                                <div class="bg-gradient-to-r from-pastel-yellow to-pastel-peach rounded-lg p-2 text-center shadow-sm">
                                    <div class="text-lg font-bold text-gray-800">${late}</div>
                                    <div class="text-xs text-gray-700">มาสาย</div>
                                </div>
                                <div class="bg-gradient-to-r from-pastel-blue to-pastel-sky rounded-lg p-2 text-center shadow-sm">
                                    <div class="text-lg font-bold text-gray-800">${excused}</div>
                                    <div class="text-xs text-gray-700">ลา</div>
                                </div>
                                <div class="bg-gradient-to-r from-pastel-coral to-pastel-pink rounded-lg p-2 text-center shadow-sm">
                                    <div class="text-lg font-bold text-gray-800">${absent}</div>
                                    <div class="text-xs text-gray-700">ไม่เข้าแถว</div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">ทั้งหมด: <span class="font-semibold">${total}</span> คน</span>
                                <span class="text-sm text-gray-600">อัตราเข้าแถว: <span class="font-semibold text-pastel-purple">${rate.toFixed(1)}%</span></span>
                            </div>                            
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm text-gray-600">อัตราการเข้าแถว</span>
                                <span class="text-sm font-semibold text-pastel-purple">${rate.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 shadow-inner">
                                <div class="bg-gradient-to-r ${colorTheme} h-3 rounded-full transition-all duration-500" 
                                     style="width: ${rate}%"></div>
                            </div>
                        `;
                        statsContainer.appendChild(div);
                    } catch (e) {
                        console.error('Error processing classroom stat:', e, stat);
                    }
                });
                
                // Add filter function to the page
                if (!window.filterClassrooms) {
                    window.filterClassrooms = function() {
                        const searchInput = document.getElementById('classroomSearch');
                        if (!searchInput) return;
                          const searchTerm = searchInput.value.toLowerCase().trim();
                        const classroomCards = document.querySelectorAll('.classroom-stat-card');
                        
                        classroomCards.forEach(card => {
                            // Make sure we're getting the actual classroom name from the card
                            const classroomNameElement = card.querySelector('h4');
                            // Only proceed if we found the element
                            if (classroomNameElement) {
                                const classroomName = classroomNameElement.textContent.toLowerCase();
                                if (searchTerm === '' || classroomName.includes(searchTerm)) {
                                    card.classList.remove('hidden');
                                } else {
                                    card.classList.add('hidden');
                                }
                            } else {
                                console.warn('Could not find classroom name element in card', card);
                            }
                        });
                    };
                }
                
            } else {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40">
                        <div class="w-16 h-16 mx-auto mb-3 bg-pastel-blue/30 rounded-full flex items-center justify-center">
                            <i class="fas fa-school text-2xl text-pastel-purple"></i>
                        </div>
                        <p class="text-gray-600">ยังไม่มีการบันทึกการเข้าแถวในวันนี้</p>                    </div>
                `;
            }
        }
        
        function updateTopAttendees(attendees) {
            const container = document.getElementById('topOverallAttendees');
            container.innerHTML = ''; // Clear
            
            console.log('Updating top attendees with:', attendees);
            
            if (!attendees) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-pastel-yellow to-pastel-peach rounded-full flex items-center justify-center shadow-md animate-pulse">
                            <i class="fas fa-medal text-2xl text-white"></i>
                        </div>
                        <p class="text-gray-600">ไม่พบข้อมูลนักเรียน</p>
                        <p class="text-xs text-gray-500 mt-1">เลือกช่วงวันที่เพื่อดูรายชื่อนักเรียนที่เข้าแถวสม่ำเสมอ</p>
                    </div>
                `;
                return;
            }
            
            if (attendees.length > 0) {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'mb-4 bg-gradient-to-r from-pastel-purple/30 to-pastel-blue/30 p-3 rounded-xl';
                titleDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-r from-pastel-yellow to-pastel-peach rounded-full flex items-center justify-center mr-2 shadow-sm">
                            <i class="fas fa-trophy text-white text-sm"></i>
                        </div>
                        <p class="text-sm text-gray-700 font-medium">นักเรียนที่เข้าแถวสม่ำเสมอในช่วงที่เลือก</p>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 px-2">
                        <span>ชื่อ-นามสกุล</span>
                        <span>จำนวนวัน</span>
                    </div>
                `;
                container.appendChild(titleDiv);
                
                // Create a wrapper for the list
                const listWrapper = document.createElement('div');
                listWrapper.className = 'space-y-2';
                container.appendChild(listWrapper);                attendees.forEach((att, index) => {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'flex justify-between items-center bg-white/80 p-4 rounded-xl hover:bg-white transition-all duration-200 shadow-md border border-white/50 transform hover:scale-102';
                    
                    // Handle potential differences in data structure (studentName vs name)
                    const studentName = att.studentName || att.name || 'Unknown Student';
                    const daysPresent = att.daysPresent || att.days || 0;
                    const studentId = att.studentId || att.id || '';
                    const classroomName = att.classroomName || '';
                    
                    // Create different badge styles for top attendees
                    let rankBadge = '';
                    let rankClass = '';
                    let iconClass = '';
                    
                    if (index === 0) {
                        rankBadge = '#1';
                        rankClass = 'from-yellow-300 to-amber-400 text-amber-800';
                        iconClass = 'fa-crown text-amber-500';
                    } else if (index === 1) {
                        rankBadge = '#2';
                        rankClass = 'from-gray-300 to-gray-400 text-gray-700';
                        iconClass = 'fa-medal text-gray-500';
                    } else if (index === 2) {
                        rankBadge = '#3';
                        rankClass = 'from-amber-600 to-amber-700 text-amber-800';
                        iconClass = 'fa-award text-amber-600';
                    } else {
                        rankBadge = `#${index + 1}`;
                        rankClass = 'from-pastel-purple/30 to-pastel-blue/30 text-pastel-purple';
                        iconClass = 'fa-user-check text-pastel-purple';
                    }
                    
                    studentCard.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r ${rankClass} flex items-center justify-center mr-3 shadow-sm">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div>                                <div class="flex items-center">
                                    <span class="bg-gradient-to-r ${rankClass} text-xs px-2 py-0.5 rounded-full font-bold mr-2">${rankBadge}</span>
                                    <p class="font-medium text-gray-800">${studentName}</p>
                                </div>
                                <div class="flex items-center flex-wrap gap-1 mt-0.5">
                                    ${studentId ? `<span class="text-xs bg-gray-100 px-1.5 py-0.5 rounded text-gray-600"><i class="fas fa-id-card mr-0.5 text-gray-400 text-xs"></i>${studentId}</span>` : ''}
                                    ${classroomName ? `<span class="text-xs bg-pastel-blue/20 px-1.5 py-0.5 rounded text-pastel-blue"><i class="fas fa-chalkboard-teacher mr-0.5 text-pastel-blue/70 text-xs"></i>${classroomName}</span>` : ''}
                                </div>
                            </div>
                        </div>                        <div class="flex flex-col items-end">
                            <div class="bg-gradient-to-r from-pastel-green to-pastel-mint px-3 py-1.5 rounded-lg shadow-sm">
                                <span class="font-bold text-gray-800">${daysPresent}</span>
                                <span class="text-sm text-gray-700"> วัน</span>
                            </div>
                            <span class="text-xs text-gray-500 mt-1">เข้าแถวสม่ำเสมอ</span>
                        </div>
                    `;
                    listWrapper.appendChild(studentCard);
                });
            } else {                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 bg-white/60 rounded-xl p-6 border border-white/50 shadow-sm">
                        <div class="w-20 h-20 mx-auto mb-3 bg-gradient-to-r from-pastel-yellow to-pastel-peach rounded-full flex items-center justify-center shadow-md">
                            <i class="fas fa-info-circle text-2xl text-white"></i>
                        </div>
                        <p class="text-gray-700 font-medium">ไม่พบข้อมูลนักเรียนในช่วงที่เลือก</p>
                        <p class="text-xs text-gray-500 mt-1">ลองเลือกช่วงเวลาที่มีการบันทึกการเข้าแถว</p>
                    </div>
                `;
            }
        }        function loadDailyStatsChartData() {
            setLoadingState(true, 'Loading daily chart...');
            console.log('Requesting daily stats with token:', currentToken ? 'Token exists' : 'No token!');
            
            if (!currentToken) {
                console.warn('WARNING: Token is missing for loadDailyStatsChartData call! Trying to recover...');
                currentToken = localStorage.getItem('jwtToken'); 
                console.log('Recovery attempt result:', currentToken ? 'Token recovered' : 'Still no token');
                
                if (!currentToken) {
                    setLoadingState(false);
                    document.getElementById('dailyStatsFallback').textContent = 'Authentication error: Missing token';
                    document.getElementById('dailyStatsFallback').classList.remove('hidden');
                    handleAuthError('Missing authentication token. Please try logging in again.');
                    return;
                }
            }
            
            google.script.run                .withSuccessHandler(function(response){
                    setLoadingState(false);
                    console.log('Daily stats response:', response);
                    
                    if(response.success && response.dailyStats){
                        console.log('Daily stats data received:', JSON.stringify(response.dailyStats, null, 2));
                        renderDailyAttendanceChart(response.dailyStats);
                        document.getElementById('dailyStatsFallback').classList.add('hidden');
                    } else {
                        document.getElementById('dailyStatsFallback').textContent = response.error || 'Could not load chart data.';
                        document.getElementById('dailyStatsFallback').classList.remove('hidden');
                        
                        if(!response.success) {
                            console.error('Failed to load daily stats:', response.error);
                            if (response.expired) {
                                handleAuthError(response.error || 'Authentication expired', response.expired);
                            }
                        }
                    }
                })
                .withFailureHandler(function(err){
                    setLoadingState(false);
                    console.error('Error in daily stats chart:', err);
                    document.getElementById('dailyStatsFallback').textContent = 'Error loading chart: ' + (err.message || 'Unknown error');
                    document.getElementById('dailyStatsFallback').classList.remove('hidden');
                    // Don't show auth error modal for chart failure, just log it
                    console.error('Error loading chart:', err);
                })
                .getDailyAttendanceStats(7, currentToken); // Get stats for last 7 days
        }
        
        var dailyChartInstance = null; // To keep track of the chart instance
        
        function renderDailyAttendanceChart(dailyData) {
            try {
                console.log('🎯 Rendering chart with daily data:', JSON.stringify(dailyData, null, 2));
                
                if (!dailyData || dailyData.length === 0) {
                    document.getElementById('dailyStatsFallback').textContent = 'No data available for chart.';
                    document.getElementById('dailyStatsFallback').classList.remove('hidden');
                    return;
                }
                
                const canvas = document.getElementById('dailyAttendanceChart');
                if (!canvas) {
                    console.error('Chart canvas element not found!');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                
                if (dailyChartInstance) {
                    dailyChartInstance.destroy(); // Destroy previous chart instance if exists
                }
                  // Format dates and extract data
                const labels = dailyData.map(d => {
                    try {
                        return new Date(d.date).toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
                    } catch (e) {
                        console.warn('Error formatting date:', d.date, e);
                        return 'Invalid date';
                    }
                });                // Combine present and late as "เข้าแถว" (lined up)
                const presentData = dailyData.map(d => (Number(d.present) || 0) + (Number(d.late) || 0));
                // Keep absent separate as "ขาด" (absent) - excused is separate
                const absentData = dailyData.map(d => Number(d.absent) || 0);
                // Add excused data as separate category
                const excusedData = dailyData.map(d => Number(d.excused) || 0);
                
                console.log('Chart data - Present+Late:', presentData, 'Absent:', absentData, 'Excused:', excusedData);
                  // Create new chart
                dailyChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,                        datasets: [
                            {
                                label: 'เข้าแถว',
                                data: presentData,
                                backgroundColor: 'rgba(186, 255, 201, 0.7)', // Matching index pastel green
                                borderColor: 'rgba(150, 230, 161, 1)',
                                borderWidth: 1,
                                borderRadius: 6,
                                hoverBackgroundColor: 'rgba(186, 255, 201, 0.9)',
                                barPercentage: 0.7
                            },                            {
                                label: 'ขาด',
                                data: absentData,
                                backgroundColor: 'rgba(255, 179, 186, 0.7)', // Matching index pastel coral
                                borderColor: 'rgba(242, 145, 155, 1)',
                                borderWidth: 1,
                                borderRadius: 6,
                                hoverBackgroundColor: 'rgba(255, 179, 186, 0.9)',
                                barPercentage: 0.7
                            },
                            {
                                label: 'ลา',
                                data: excusedData,
                                backgroundColor: 'rgba(186, 225, 255, 0.7)', // Matching pastel blue
                                borderColor: 'rgba(158, 206, 255, 1)',
                                borderWidth: 1,
                                borderRadius: 6,
                                hoverBackgroundColor: 'rgba(186, 225, 255, 0.9)',
                                barPercentage: 0.7
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20,
                                    font: {
                                        family: "'Kanit', sans-serif",
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                titleColor: '#333',
                                bodyColor: '#666',
                                bodyFont: {
                                    family: "'Kanit', sans-serif"
                                },
                                borderColor: 'rgba(225, 186, 255, 0.5)',
                                borderWidth: 1,
                                padding: 10,
                                boxPadding: 5,
                                usePointStyle: true,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        return `${label}: ${value} คน`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    stepSize: 1,
                                    font: {
                                        family: "'Kanit', sans-serif"
                                    }
                                },
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.2)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: "'Kanit', sans-serif"
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                // Hide the fallback message
                document.getElementById('dailyStatsFallback').classList.add('hidden');
                
            } catch (error) {
                console.error('Error rendering chart:', error);
                document.getElementById('dailyStatsFallback').textContent = 'Error rendering chart: ' + error.message;
                document.getElementById('dailyStatsFallback').classList.remove('hidden');
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('th-TH', options);
        }

        // --- Error Modal --- (Shared with index.html, ensure it's defined or include if separate)
        function showErrorModal(message, isAuthError = false) {
            document.getElementById('errorContent').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
            const closeButton = document.getElementById('errorModal').querySelector('button');
            
            if (isAuthError) {
                closeButton.onclick = function() { closeModalAndMaybeLogout(); };
            } else {
                closeButton.onclick = function() { closeModal(); };
            }
        }
        
        function closeModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        function closeModalAndLogout() {
            closeModal();
            redirectToLogin('Your session is no longer valid. Please login again.');
        }

        function closeModalAndMaybeLogout() { // Renamed to be more specific
            closeModal();
            // This function is called from the modal. If it was an auth error, it should trigger logout.
            // The logic in showErrorModal sets the button's onclick to closeModalAndLogout if isAuthError is true.
            // So, if we reach here via that path, we should log out.
            // We need a way to know if this specific modal instance was for an auth error.
            // The simplest is to rely on the onclick being set correctly by showErrorModal.
            // If the button was set to call this, and it was an auth error, then proceed to logout.
            const isLikelyAuthError = document.getElementById('errorContent').textContent.toLowerCase().includes('authentication') || document.getElementById('errorContent').textContent.toLowerCase().includes('session');
            const isExpiredToken = document.getElementById('errorContent').textContent.toLowerCase().includes('token expired');
            if(isLikelyAuthError || isExpiredToken){
                redirectToLogin('Your session is no longer valid. Please login again.');
            }        }        
        // Assumed new Code.gs functions:
        // google.script.run.getDashboardData(dateFrom, dateTo, currentToken);
        // google.script.run.getDailyAttendanceStats(days, currentToken);
    </script>
</body>
</html>
