<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อการเข้าแถวตอนเช้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            pink: '#FFB3BA',
                            peach: '#FFDFBA',
                            yellow: '#FFFFBA',
                            green: '#BAFFC9',
                            blue: '#BAE1FF',
                            purple: '#E1BAFF',
                            lavender: '#F0E6FF',
                            mint: '#E6FFE6',
                            coral: '#FFE6E6',
                            sky: '#E6F3FF'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
        }
        .glass-effect {
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .blur-backdrop {
            backdrop-filter: blur(10px);
        }
        .simple-hover:hover {
            opacity: 0.9;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pastel-pink via-pastel-peach to-pastel-yellow">
    <!-- Authentication Message Area -->
    <div id="authMessageArea" class="hidden fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center p-8 bg-white shadow-lg rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Authentication Required</h2>
            <p id="authMessageText" class="text-gray-600 mb-6">You need to be logged in to access this page.</p>
            <a id="authLoginLink" href="#" class="bg-pastel-purple text-white font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                Go to Login
            </a>
        </div>
    </div>

    <!-- Main Content Wrapper (initially hidden if auth message is shown) -->
    <div id="mainContentWrapper">
        <!-- Header -->
        <header class="glass-effect blur-backdrop border-b border-white/20 sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-gradient-to-r from-pastel-purple to-pastel-blue rounded-full flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ระบบเช็คชื่อการเข้าแถวตอนเช้า</h1>
                            <p class="text-sm text-gray-600" id="currentDateTime"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Navigation -->                        <div class="flex space-x-2">
                            <a 
                                href="#" 
                                id="navIndexLink"
                                onclick="navigateTo('index')" 
                                class="px-4 py-2 rounded-lg font-semibold bg-pastel-green text-gray-800"
                            >
                                <i class="fas fa-check-circle mr-1"></i>
                                เช็คชื่อ
                            </a>
                            <a 
                                href="#" 
                                id="navDashboardLink"
                                onclick="navigateTo('dashboard')" 
                                class="px-4 py-2 rounded-lg font-semibold bg-white/50 text-gray-600 hover:bg-white/70"
                            >
                                <i class="fas fa-chart-pie mr-1"></i>
                                Dashboard
                            </a>                            <a 
                                href="#" 
                                id="navSearchLink"
                                onclick="navigateTo('search')" 
                                class="px-4 py-2 rounded-lg font-semibold bg-white/50 text-gray-600 hover:bg-white/70 hidden"
                            >
                                <i class="fas fa-search mr-1"></i>
                                ค้นหา
                            </a>
                        </div>                        <div id="userInfoDisplay" class="text-sm text-gray-700"></div>
                        <button 
                            id="logoutButton"
                            class="px-4 py-2 rounded-lg font-semibold bg-pastel-coral text-gray-800 hover:opacity-90 hidden"
                        >
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            ออกจากระบบ
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8">
            <!-- Attendance Section -->
            <div id="attendanceSection" class="grid lg:grid-cols-3 gap-8">
                <!-- Check-in Panel -->
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-2xl p-8 simple-hover">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">เช็คชื่อนักเรียน</h2>
                            <p class="text-gray-600">เลือกห้องเรียนเพื่อแสดงรายชื่อนักเรียน</p>
                        </div>                        <!-- Classroom Selection -->
                        <div class="mb-8">
                            <label class="block text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-door-open text-pastel-purple mr-2"></i>
                                เลือกห้องเรียน
                            </label>
                            <div class="relative">
                                <select 
                                    id="classroomSelect" 
                                    class="w-full px-6 py-4 text-lg border-2 border-pastel-blue/50 rounded-xl focus:border-pastel-purple focus:outline-none bg-white/90 appearance-none"
                                    onchange="loadClassroomStudents()"
                                >
                                    <option value="">-- เลือกห้องเรียน --</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Students List -->                        <div id="studentsListContainer" class="hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-users text-pastel-purple mr-2"></i>
                                    รายชื่อนักเรียน
                                </h3>
                                <div class="flex space-x-3">
                                    <button 
                                        onclick="markAllPresent()" 
                                        class="bg-gradient-to-r from-pastel-green to-pastel-mint text-gray-800 font-semibold py-2 px-5 rounded-xl hover:shadow-lg transition-all duration-200 text-sm"
                                    >
                                        <i class="fas fa-check-double mr-1"></i>
                                        เข้าแถวทั้งหมด
                                    </button>
                                    <button 
                                        onclick="markAllAbsent()" 
                                        class="bg-gradient-to-r from-pastel-coral to-pastel-pink text-gray-800 font-semibold py-2 px-5 rounded-xl hover:shadow-lg transition-all duration-200 text-sm"
                                    >
                                        <i class="fas fa-times-circle mr-1"></i>
                                        ไม่เข้าแถวทั้งหมด
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Student Search Box -->
                            <div class="mb-4 relative">
                                <input 
                                    id="studentSearch" 
                                    type="text" 
                                    placeholder="ค้นหาชื่อนักเรียน..." 
                                    class="w-full px-4 py-3 pr-10 border-2 border-pastel-blue/20 rounded-xl focus:border-pastel-purple focus:outline-none bg-white/80"
                                    oninput="filterStudents()"
                                >
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                            
                            <!-- Legend for attendance status -->
                            <div class="flex flex-wrap justify-center gap-3 mb-4 text-xs">
                                <div class="flex items-center">
                                    <span class="inline-block w-3 h-3 rounded-full bg-gradient-to-r from-pastel-green to-pastel-mint mr-1"></span>
                                    <span>เข้าแถว</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="inline-block w-3 h-3 rounded-full bg-gradient-to-r from-pastel-coral to-pastel-pink mr-1"></span>
                                    <span>ไม่เข้าแถว</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="inline-block w-3 h-3 rounded-full bg-gradient-to-r from-pastel-yellow to-pastel-peach mr-1"></span>
                                    <span>มาสาย</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="inline-block w-3 h-3 rounded-full bg-gradient-to-r from-pastel-blue to-pastel-sky mr-1"></span>
                                    <span>ลา</span>
                                </div>
                            </div>
                            
                            <div id="studentsList" class="space-y-2 max-h-96 overflow-y-auto pr-1">
                                <!-- Students will be loaded here -->
                            </div>
                            
                            <!-- No results message -->
                            <div id="noStudentsFound" class="hidden text-center py-6 text-gray-500">
                                <i class="fas fa-search text-3xl mb-2 text-gray-400"></i>
                                <p>ไม่พบนักเรียนที่ค้นหา</p>
                            </div>
                        </div>                        <!-- Loading Indicator -->
                        <div id="loadingIndicator" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50">
                            <div class="glass-effect rounded-xl p-8 text-center">
                                <div class="mb-4 relative">
                                    <div class="w-16 h-16 border-4 border-pastel-purple border-t-transparent rounded-full animate-spin mx-auto"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <i class="fas fa-school text-pastel-purple text-sm"></i>
                                    </div>
                                </div>
                                <p id="loadingMessage" class="text-lg font-medium text-gray-700">กำลังประมวลผล...</p>
                                <p class="text-sm text-gray-500 mt-1">โปรดรอสักครู่</p>
                            </div>
                        </div>

                        <!-- Result Display -->
                        <div id="resultDisplay" class="hidden"></div>
                    </div>
                </div>
                <!-- Side Panel -->
                <div class="space-y-6">                    <!-- Classroom Info Card -->
                    <div class="glass-effect rounded-2xl p-6 simple-hover">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chalkboard-teacher text-pastel-purple mr-2"></i>
                            ข้อมูลห้องเรียน
                        </h3>
                        <div id="classroomInfo" class="text-gray-600">
                            <div class="flex items-center justify-center h-48">
                                <div class="text-center">
                                    <div class="w-16 h-16 mx-auto mb-3 bg-pastel-blue/30 rounded-full flex items-center justify-center">
                                        <i class="fas fa-school text-2xl text-pastel-purple"></i>
                                    </div>
                                    <p class="text-gray-600">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="glass-effect rounded-2xl p-6 simple-hover">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-pastel-purple mr-2"></i>
                            สถิติการเข้าแถว
                        </h3>                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">เข้าแถว</span>
                                <span class="text-2xl font-bold text-green-600" id="statsPresent">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ไม่เข้าแถว</span>
                                <span class="text-2xl font-bold text-red-500" id="statsAbsent">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ยังไม่บันทึก</span>
                                <span class="text-2xl font-bold text-gray-500" id="statsUnmarked">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="attendanceProgress" class="bg-gradient-to-r from-pastel-green to-pastel-mint h-3 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 text-center">
                                เปอร์เซ็นต์การเข้าแถว: <span id="attendancePercentage" class="font-semibold">0%</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Modal (same as dashboard) -->
        <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="glass-effect blur-backdrop rounded-2xl p-8 m-4 max-w-md w-full text-center">
                <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-300 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">เกิดข้อผิดพลาด</h3>
                <div id="errorContent" class="text-gray-700"></div>
                <button onclick="closeModalAndMaybeLogout()" class="mt-6 bg-gradient-to-r from-pastel-coral to-pastel-pink text-gray-800 font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                    ปิด
                </button>
            </div>
        </div>        <script>
            const appUrl = '<?!= appUrl ?>'; // Injected by Apps Script doGet
            let currentUser = null;
            let currentToken = localStorage.getItem('jwtToken'); // Initialize on script load, not just in DOMContentLoaded

            // For debugging
            console.log('Token initialized from localStorage:', currentToken ? 'Token exists' : 'No token found');

            // Helper function for top-level navigation in Apps Script
            function triggerTopNavigation(url) {
                window.top.location.href = url; // Directly set the href for top-level navigation
            }

            document.addEventListener('DOMContentLoaded', function() {
                // Token already initialized globally, but we'll check it again here
                if (!currentToken) {
                    currentToken = localStorage.getItem('jwtToken');
                    console.log('Token re-checked in DOMContentLoaded:', currentToken ? 'Token exists' : 'No token found');
                }
                const storedUserInfo = localStorage.getItem('userInfo');
                const mainContentWrapper = document.getElementById('mainContentWrapper');
                const authMessageArea = document.getElementById('authMessageArea');
                const authLoginLink = document.getElementById('authLoginLink');

                if (!currentToken) {
                    // Instead of redirecting, show the auth message and hide main content
                    mainContentWrapper.classList.add('hidden');
                    authMessageArea.classList.remove('hidden');
                    const loginUrl = appUrl + '?page=login&infoMessage=' + encodeURIComponent('Please login to continue.');
                    authLoginLink.href = loginUrl; 
                    // Ensure the link uses triggerTopNavigation if it needs to overcome sandbox issues for some reason,
                    // but a direct href to a top navigation should work if user clicks.
                    authLoginLink.onclick = function(e) { 
                        e.preventDefault(); 
                        triggerTopNavigation(loginUrl);
                    };
                    return; // Stop further execution
                }

                // If token exists, hide auth message and show main content
                mainContentWrapper.classList.remove('hidden');
                authMessageArea.classList.add('hidden');

                if (storedUserInfo) {
                    currentUser = JSON.parse(storedUserInfo);
                    initializePage();
                } else {
                    // If token exists but no user info, try to fetch it
                    // This case might happen if user info wasn't stored properly or cleared
                    setLoading(true, 'Verifying session...');
                    google.script.run
                        .withSuccessHandler(function(response) {
                            setLoading(false);
                            if (response.success && response.user) {
                                currentUser = response.user;
                                localStorage.setItem('userInfo', JSON.stringify(currentUser)); // Store it now
                                initializePage();
                            } else {
                                handleAuthError(response.error || 'Invalid session. Please login again.', response.expired);
                            }
                        })
                        .withFailureHandler(function(error) {
                            setLoading(false);
                            handleAuthError('Error verifying session: ' + error.message);
                        })
                        .getUserDataFromToken(currentToken);
                }
            });

            function initializePage() {
                if (!currentUser) {
                    redirectToLogin('User data not available. Please login.');
                    return;
                }
                console.log('User authenticated:', currentUser.username, 'Role:', currentUser.role);
                updateUserInfoDisplay();
                setupLogoutButton();
                setupNavigation();
                loadInitialData(); // For student lists, classrooms etc.
                updateDateTime();
                setInterval(updateDateTime, 1000);
            }

            function updateUserInfoDisplay() {
                const userInfoDisplay = document.getElementById('userInfoDisplay');
                if (userInfoDisplay && currentUser) {
                    userInfoDisplay.textContent = `Welcome, ${currentUser.fullName} (${currentUser.role})`;
                }
            }

            function setupLogoutButton() {
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton) {
                    logoutButton.classList.remove('hidden');
                    logoutButton.addEventListener('click', function() {
                        setLoading(true, 'Logging out...');
                        // Optional: Call server-side logout for logging, though JWT logout is client-side primarily
                        google.script.run
                            .withSuccessHandler(function(response) {
                                // Regardless of server response, clear client-side token
                                localStorage.removeItem('jwtToken');
                                localStorage.removeItem('userInfo');
                                redirectToLogin('You have been logged out.');
                            })
                            .withFailureHandler(function(error) {
                                // Still clear client-side token even if server call fails
                                localStorage.removeItem('jwtToken');
                                localStorage.removeItem('userInfo');
                                redirectToLogin('Logout completed. Server notification failed.');
                            })
                            .logoutUser(currentToken); // Pass token if server needs it for blocklisting etc.
                });
            }
        }            function setupNavigation() {
                const navIndexLink = document.getElementById('navIndexLink');
                const navDashboardLink = document.getElementById('navDashboardLink');
                const navSearchLink = document.getElementById('navSearchLink');

                if (navIndexLink) {
                    navIndexLink.onclick = function(e) { e.preventDefault(); navigateTo('index'); };
                }
                if (navDashboardLink) {
                    navDashboardLink.onclick = function(e) { e.preventDefault(); navigateTo('dashboard'); };
                    // Show dashboard link only if admin/teacher
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'teacher')) {
                        navDashboardLink.classList.remove('hidden'); 
                    } else {
                        navDashboardLink.classList.add('hidden');
                    }
                }
                if (navSearchLink) {
                    navSearchLink.onclick = function(e) { e.preventDefault(); navigateTo('search'); };
                    // Show search link only if admin/teacher
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'teacher')) {
                        navSearchLink.classList.remove('hidden'); 
                    } else {
                        navSearchLink.classList.add('hidden');
                    }
                }
            }
            
            function navigateTo(page) {
                // window.top.location.href = appUrl + '?page=' + page;
                triggerTopNavigation(appUrl + '?page=' + page);
            }

            function redirectToLogin(message) {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userInfo');
                let loginUrl = appUrl + '?page=login';
                if (message) {
                    loginUrl += '&infoMessage=' + encodeURIComponent(message);
                }
                // setTimeout removed as the main issue was initial load without user activation
                triggerTopNavigation(loginUrl);
            }

            function handleAuthError(errorMessage, isExpired) {
                console.error('Auth Error:', errorMessage);
                showErrorModal('Authentication Error: ' + errorMessage + (isExpired ? ' (Token Expired)' : ''), true);
                // The modal's close button will handle logout via closeModalAndMaybeLogout
            }            function setLoading(isLoading, message = 'กำลังประมวลผล...') {
                const indicator = document.getElementById('loadingIndicator');
                const loadingMessage = document.getElementById('loadingMessage');
                
                if (indicator) {
                    if (isLoading) {
                        // Update message
                        if (loadingMessage) {
                            loadingMessage.textContent = message;
                        }
                        
                        // Show loading with fade-in animation
                        document.body.classList.add('overflow-hidden'); // Prevent scrolling while loading
                        indicator.style.opacity = '0';
                        indicator.classList.remove('hidden');
                        
                        setTimeout(() => {
                            indicator.style.transition = 'opacity 0.3s ease-in';
                            indicator.style.opacity = '1';
                        }, 10);
                        
                    } else {
                        // Fade out animation
                        indicator.style.transition = 'opacity 0.3s ease-out';
                        indicator.style.opacity = '0';
                        
                        setTimeout(() => {
                            indicator.classList.add('hidden');
                            document.body.classList.remove('overflow-hidden');
                            indicator.style.transition = '';
                            indicator.style.opacity = '1';
                        }, 300);
                    }
                }
            }

            function loadInitialData() {
                setLoading(true, 'Loading initial data...');
                let classroomLoaded = false;
                let statsLoaded = false;

                function checkAllLoaded() {
                    if (classroomLoaded && statsLoaded) {
                        setLoading(false);
                    }
                }

                // Fetch classrooms
                google.script.run
                    .withSuccessHandler(function(response) {
                        classroomLoaded = true;
                        if (response.success && response.classrooms) {
                            populateClassroomDropdown(response.classrooms);
                        } else if (!response.success) {
                            handleAuthError(response.error || 'Failed to load classrooms.', response.expired);
                        }
                        checkAllLoaded();
                    })
                    .withFailureHandler(function(error) {
                        classroomLoaded = true;
                        handleAuthError('Error loading classrooms: ' + error.message);
                        checkAllLoaded();
                    })                    .getClassrooms(currentToken);

                // Fetch daily attendance stats
                console.log('About to call getDailyAttendanceStats with token:', currentToken ? 'Token exists' : 'No token!');
                if (!currentToken) {
                    console.warn('WARNING: Token is missing for getDailyAttendanceStats call! Trying to recover...');
                    currentToken = localStorage.getItem('jwtToken'); 
                    console.log('Recovery attempt result:', currentToken ? 'Token recovered' : 'Still no token');
                }
                
                google.script.run
                    .withSuccessHandler(function(response) {
                        statsLoaded = true;
                        console.log('getDailyAttendanceStats response:', response);                        if (response.success) {
                            if (response.totalPresentToday !== undefined) {
                                // Today count display removed from navbar
                            } else if (response.dailyStats && response.dailyStats.length > 0) {
                                // If we have daily stats, use them to calculate total present for today
                                const today = new Date();
                                const todayString = today.getFullYear() + '-' + 
                                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                    String(today.getDate()).padStart(2, '0');
                                  const todayStat = response.dailyStats.find(stat => stat.date === todayString);
                                if (todayStat) {
                                    // Data loaded successfully but display removed from navbar
                                } else {
                                    console.warn('No stats found for today in dailyStats array');
                                }
                            } else {
                                console.warn('Daily attendance stats loaded successfully but data is missing.');
                            }
                        } else {                            console.error('Failed to load daily attendance stats:', response.error || 'Unknown error');
                            if(response.expired) {
                                handleAuthError(response.error || 'Session expired while loading daily stats.', response.expired);
                            } else {
                                // Today count display removed from navbar
                            }
                        }                        checkAllLoaded();
                    })                    .withFailureHandler(function(error) {
                        statsLoaded = true;
                        console.error('Error loading daily attendance stats:', error.message);
                        // Today count display removed from navbar
                        checkAllLoaded();
                    })
                    .getDailyAttendanceStats(7, currentToken); // Pass days=7 as first parameter
            }

            function populateClassroomDropdown(classrooms) {
                const select = document.getElementById('classroomSelect');
                if (!select) return;
                select.innerHTML = '<option value="">-- เลือกห้องเรียน --</option>'; // Clear existing
                classrooms.forEach(classroom => {
                    const option = document.createElement('option');
                    option.value = classroom.id; // Assuming classroom object has id and name
                    option.textContent = classroom.name;
                    select.appendChild(option);
                });
            }            function loadClassroomStudents() {
                const classroomSelect = document.getElementById('classroomSelect');
                const selectedClassroomId = classroomSelect.value;
                const studentsListDiv = document.getElementById('studentsList');
                const studentsListContainer = document.getElementById('studentsListContainer');
                const resultDisplay = document.getElementById('resultDisplay');

                if (!selectedClassroomId) {
                    studentsListContainer.classList.add('hidden');
                    studentsListDiv.innerHTML = '';
                    updateStats([], {}); // Clear stats
                    return;
                }

                setLoading(true, 'กำลังโหลดข้อมูลนักเรียน...');
                resultDisplay.classList.add('hidden');
                resultDisplay.textContent = '';
                
                // First get the list of students
                google.script.run
                    .withSuccessHandler(function(studentsResponse) {
                        if (studentsResponse.success && studentsResponse.students) {
                            // After getting students, fetch today's attendance records for this classroom
                            google.script.run
                                .withSuccessHandler(function(attendanceResponse) {
                                    setLoading(false);
                                    
                                    let existingAttendance = {};
                                    if (attendanceResponse.success && attendanceResponse.attendanceRecords) {
                                        existingAttendance = attendanceResponse.attendanceRecords;
                                        console.log('Loaded existing attendance records:', existingAttendance);
                                    }
                                    
                                    // Render students with their existing attendance statuses
                                    renderStudents(studentsResponse.students, existingAttendance);
                                    studentsListContainer.classList.remove('hidden');
                                })
                                .withFailureHandler(function(error) {
                                    setLoading(false);
                                    console.error('Error loading attendance records:', error);
                                    // Even if attendance fails, still show students
                                    renderStudents(studentsResponse.students, {});
                                    studentsListContainer.classList.remove('hidden');
                                })
                                .getTodayAttendanceByClassroom(selectedClassroomId, currentToken);
                        } else if (!studentsResponse.success) {
                            setLoading(false);
                            handleAuthError(studentsResponse.error || 'Failed to load students.', studentsResponse.expired);
                            studentsListContainer.classList.add('hidden');
                        }
                    })
                    .withFailureHandler(function(error) {
                        setLoading(false);
                        handleAuthError('Error loading students: ' + error.message);
                        studentsListContainer.classList.add('hidden');
                    })
                    .getStudentsByClassroom(selectedClassroomId, currentToken);
            }            let currentStudents = []; // To keep track of students for the current classroom
            let attendanceStatus = {}; // studentId: 'present'/'absent'/'late'
            
            function renderStudents(students, existingAttendance) {
                console.log('renderStudents called with', students.length, 'students and', 
                    existingAttendance ? Object.keys(existingAttendance).length : 0, 'attendance records');
                    
                currentStudents = students;
                attendanceStatus = {}; // Reset status for new list
                
                // Apply any existing attendance records that came from the server
                if (existingAttendance && typeof existingAttendance === 'object') {
                    console.log('Applying existing attendance records to UI:', existingAttendance);
                    Object.keys(existingAttendance).forEach(studentId => {
                        attendanceStatus[studentId] = existingAttendance[studentId];
                    });
                }
                
                const listDiv = document.getElementById('studentsList');
                listDiv.innerHTML = ''; // Clear previous list
                
                if (students.length === 0) {
                    listDiv.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10">
                            <div class="w-20 h-20 bg-pastel-blue/20 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-user-slash text-3xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-500 text-center">ไม่พบนักเรียนในห้องเรียนนี้</p>
                        </div>
                    `;
                    updateStats(students, attendanceStatus);
                    return;
                }
                
                students.forEach(student => {
                    const studentId = student.id; // Assuming student object has id, firstName, lastName
                    // If this student has no attendance status yet in our status map, set to null (unmarked)
                    if (attendanceStatus[studentId] === undefined) {
                        attendanceStatus[studentId] = null;
                    }
                    
                    const card = document.createElement('div');
                    card.className = 'student-card mb-3 glass-effect p-4 rounded-xl flex items-center justify-between transition-all duration-300 hover:shadow-lg border border-white/20';
                    card.id = `student-${studentId}`;

                    card.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-pastel-purple to-pastel-blue flex items-center justify-center mr-4 shadow-sm">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700 text-lg">${student.firstName} ${student.lastName}</p>
                                <p class="text-xs text-gray-500">รหัสนักเรียน: ${studentId}</p>
                            </div>
                        </div>
                        <div class="student-actions flex space-x-2">
                            <button 
                                title="เข้าแถว" 
                                onclick="markStudent('${studentId}', 'present')" 
                                class="action-btn bg-gradient-to-r from-pastel-green/70 to-pastel-mint/70 hover:from-pastel-green hover:to-pastel-mint text-green-800 w-9 h-9 rounded-full flex items-center justify-center transition-all duration-150"
                            >
                                <i class="fas fa-check"></i>
                            </button>
                            <button 
                                title="ไม่เข้าแถว" 
                                onclick="markStudent('${studentId}', 'absent')" 
                                class="action-btn bg-gradient-to-r from-pastel-coral/70 to-pastel-pink/70 hover:from-pastel-coral hover:to-pastel-pink text-red-800 w-9 h-9 rounded-full flex items-center justify-center transition-all duration-150"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                            <button 
                                title="มาสาย" 
                                onclick="markStudent('${studentId}', 'late')" 
                                class="action-btn bg-gradient-to-r from-pastel-yellow/70 to-pastel-peach/70 hover:from-pastel-yellow hover:to-pastel-peach text-yellow-800 w-9 h-9 rounded-full flex items-center justify-center transition-all duration-150"
                            >
                                <i class="fas fa-clock"></i>
                            </button>
                            <button 
                                title="ลา" 
                                onclick="markStudent('${studentId}', 'excused')" 
                                class="action-btn bg-gradient-to-r from-pastel-blue/70 to-pastel-sky/70 hover:from-pastel-blue hover:to-pastel-sky text-blue-800 w-9 h-9 rounded-full flex items-center justify-center transition-all duration-150"
                            >
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    `;
                    listDiv.appendChild(card);
                    
                    // If this student has a status already, highlight the corresponding button
                    if (attendanceStatus[studentId]) {
                        // Apply visual highlighting to the appropriate button after a short delay to ensure DOM is ready
                        setTimeout(() => {
                            // Call markStudent to set UI cues, but not to re-trigger server call for initial state
                            markStudent(studentId, attendanceStatus[studentId], true /* isInitialSet */);
                        }, 50);
                    }
                });
                updateStats(students, attendanceStatus);
            }
            
            function markStudent(studentId, status, isInitialSet = false) { // Added isInitialSet parameter
                attendanceStatus[studentId] = status;
                const card = document.getElementById(`student-${studentId}`);
                const buttons = card.querySelectorAll('.action-btn');
                
                // Remove active style from all buttons
                buttons.forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'shadow-lg', 'scale-110');
                    btn.style.transform = '';
                    // Also remove specific ring colors
                    ['ring-green-500', 'ring-red-500', 'ring-yellow-500', 'ring-blue-500'].forEach(ringClass => {
                        btn.classList.remove(ringClass);
                    });
                });
                
                // Determine which button to highlight
                let targetButton;
                if (status === 'present') targetButton = card.querySelector('button[title="เข้าแถว"]');
                else if (status === 'absent') targetButton = card.querySelector('button[title="ไม่เข้าแถว"]');
                else if (status === 'late') targetButton = card.querySelector('button[title="มาสาย"]');
                else if (status === 'excused') targetButton = card.querySelector('button[title="ลา"]');

                // Apply active style to the selected button
                if (targetButton) {
                    targetButton.classList.add('ring-2', 'ring-offset-2', 'shadow-lg');
                    targetButton.style.transform = 'scale(1.1)';
                    
                    // Define ring colors based on status
                    const ringColors = {
                        'present': 'ring-green-500',
                        'absent': 'ring-red-500',
                        'late': 'ring-yellow-500',
                        'excused': 'ring-blue-500'
                    };
                    
                    if (ringColors[status]) {
                        targetButton.classList.add(ringColors[status]);
                    }
                    
                    // Add animation effect only if not initial set, to avoid spamming animations on load
                    if (!isInitialSet) {
                        targetButton.animate([
                            { transform: 'scale(1.2)' },
                            { transform: 'scale(1.1)' }
                        ], {
                            duration: 200,
                            iterations: 1
                        });
                    }
                }
                updateStats(currentStudents, attendanceStatus);
                
                // If this is just for setting the initial UI based on loaded data, don't call the server.
                if (isInitialSet) {
                    return;
                }
                
                // Call server to record this single attendance event
                setLoading(true, 'Recording attendance...');
                google.script.run
                    .withSuccessHandler(function(response) {
                        setLoading(false);                        const resultDisplay = document.getElementById('resultDisplay');
                        
                        // Create a more visually appealing result notification
                        if (response.success) {
                            resultDisplay.innerHTML = `
                                <div class="flex items-center bg-gradient-to-r from-pastel-green/30 to-pastel-mint/30 p-3 rounded-lg border border-green-200">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-check text-green-600"></i>
                                    </div>
                                    <span>${response.message}</span>
                                </div>
                            `;
                        } else {
                            resultDisplay.innerHTML = `
                                <div class="flex items-center bg-gradient-to-r from-pastel-coral/30 to-pastel-pink/30 p-3 rounded-lg border border-red-200">
                                    <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-exclamation-circle text-red-600"></i>
                                    </div>
                                    <span>${response.message}</span>
                                </div>
                            `;
                        }
                        
                        resultDisplay.classList.remove('hidden');
                        
                        // Create smooth fade out effect
                        setTimeout(() => {
                            resultDisplay.style.opacity = '1';
                            setTimeout(() => {
                                resultDisplay.style.transition = 'opacity 0.5s ease-out';
                                resultDisplay.style.opacity = '0';
                                setTimeout(() => {
                                    resultDisplay.classList.add('hidden');
                                    resultDisplay.style.opacity = '1';
                                    resultDisplay.style.transition = '';
                                }, 500);
                            }, 2000);
                        }, 0);
                          if (response.success) {
                            if (response.newTotalPresentToday !== undefined) {
                                // Today count display removed from navbar
                            }
                        } else {
                             handleAuthError(response.message || 'Failed to record attendance.', response.expired);
                        }
                    })
                    .withFailureHandler(function(error) {
                        setLoading(false);
                        handleAuthError('Error recording attendance: ' + error.message);
                    })
                    .recordAttendance(studentId, status, currentToken);
            }

            function markAllPresent() {
                currentStudents.forEach(student => markStudent(student.id, 'present'));
                // Note: markStudent calls recordAttendance for each. For bulk, a different server fn might be better.
            }

            function markAllAbsent() {
                currentStudents.forEach(student => markStudent(student.id, 'absent'));
            }

            function updateStats(students, statuses) {
                let present = 0, absent = 0, late = 0, excused = 0, unmarked = 0;
                students.forEach(student => {
                    const status = statuses[student.id];
                    if (status === 'present') present++;
                    else if (status === 'absent') absent++;
                    else if (status === 'late') late++; // Late is also considered present for some counts
                    else if (status === 'excused') excused++;
                    else unmarked++;
                });

                document.getElementById('statsPresent').textContent = present + late; // Count late as present for this stat
                document.getElementById('statsAbsent').textContent = absent;
                document.getElementById('statsUnmarked').textContent = unmarked;

                const totalStudents = students.length;
                const markedStudents = totalStudents - unmarked;
                let attendanceRate = 0;
                if (markedStudents > 0) {
                    // Consider present and late as 'attended' for rate calculation
                    attendanceRate = ((present + late) / markedStudents) * 100;
                }
                
                const progressPercentage = totalStudents > 0 ? (markedStudents / totalStudents) * 100 : 0;
                document.getElementById('attendanceProgress').style.width = `${progressPercentage}%`;
                document.getElementById('attendancePercentage').textContent = `${attendanceRate.toFixed(0)}%`;
                  // Update classroom info with a more beautiful design
                const classroomSelect = document.getElementById('classroomSelect');
                const classroomInfoDiv = document.getElementById('classroomInfo');
                
                if (classroomSelect.value) {
                    const classroomName = classroomSelect.options[classroomSelect.selectedIndex].text;
                    const totalPresent = present + late;
                    
                    classroomInfoDiv.innerHTML = `
                        <div class="mb-4 text-center">
                            <h4 class="text-xl font-bold text-gray-800 mb-1">${classroomName}</h4>
                            <p class="text-sm text-gray-600">จำนวนนักเรียนทั้งหมด: ${totalStudents} คน</p>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                            <!-- Present Card -->
                            <div class="bg-gradient-to-r from-pastel-green to-pastel-mint rounded-xl p-3 text-center">
                                <div class="w-10 h-10 mx-auto mb-1 bg-white/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-check text-green-700"></i>
                                </div>
                                <p class="text-xl font-bold text-gray-800">${totalPresent}</p>
                                <p class="text-xs text-gray-700">เข้าแถว</p>
                            </div>
                            
                            <!-- Absent Card -->
                            <div class="bg-gradient-to-r from-pastel-coral to-pastel-pink rounded-xl p-3 text-center">
                                <div class="w-10 h-10 mx-auto mb-1 bg-white/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-times text-red-700"></i>
                                </div>
                                <p class="text-xl font-bold text-gray-800">${absent}</p>
                                <p class="text-xs text-gray-700">ไม่เข้าแถว</p>
                            </div>
                            
                            <!-- Leave Card -->
                            <div class="bg-gradient-to-r from-pastel-blue to-pastel-sky rounded-xl p-3 text-center">
                                <div class="w-10 h-10 mx-auto mb-1 bg-white/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calendar-minus text-blue-700"></i>
                                </div>
                                <p class="text-xl font-bold text-gray-800">${excused}</p>
                                <p class="text-xs text-gray-700">ลา</p>
                            </div>
                        </div>
                        
                        <!-- Attendance Rate Progress -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>อัตราการเข้าแถว</span>
                                <span class="font-semibold">${attendanceRate.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-gradient-to-r from-pastel-green to-pastel-mint h-3 rounded-full transition-all duration-300" style="width: ${attendanceRate}%"></div>
                            </div>
                        </div>
                    `;
                } else {
                    classroomInfoDiv.innerHTML = `
                        <div class="flex items-center justify-center h-48">
                            <div class="text-center">
                                <div class="w-16 h-16 mx-auto mb-3 bg-pastel-blue/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-school text-2xl text-pastel-purple"></i>
                                </div>
                                <p class="text-gray-600">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</p>
                            </div>
                        </div>
                    `;
                }
            }

            function updateDateTime() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                document.getElementById('currentDateTime').textContent = now.toLocaleDateString('th-TH', options);
            }

            // --- Error Modal --- 
            function showErrorModal(message, isAuthError = false) {
                document.getElementById('errorContent').textContent = message;
                document.getElementById('errorModal').classList.remove('hidden');
                // Change button behavior if it's an auth error that requires logout
                const closeButton = document.getElementById('errorModal').querySelector('button');
                if (isAuthError) {
                    closeButton.onclick = function() { closeModalAndLogout(); };
                } else {
                    closeButton.onclick = function() { closeModal(); };
                }
            }

            function closeModal() {
                document.getElementById('errorModal').classList.add('hidden');
            }

            function closeModalAndLogout() {
                closeModal();
                redirectToLogin('Your session is no longer valid. Please login again.');
            }            // Function to filter students based on search input
            function filterStudents() {
                const searchInput = document.getElementById('studentSearch');
                const searchTerm = searchInput.value.toLowerCase().trim();
                const studentCards = document.querySelectorAll('.student-card');
                const noResultsElement = document.getElementById('noStudentsFound');
                
                let matchCount = 0;
                
                studentCards.forEach(card => {
                    const studentName = card.querySelector('.font-semibold').textContent.toLowerCase();
                    const studentId = card.id.replace('student-', '');
                    
                    if (searchTerm === '' || studentName.includes(searchTerm) || studentId.includes(searchTerm)) {
                        card.classList.remove('hidden');
                        matchCount++;
                    } else {
                        card.classList.add('hidden');
                    }
                });
                
                // Show/hide no results message
                if (matchCount === 0 && searchTerm !== '') {
                    noResultsElement.classList.remove('hidden');
                } else {
                    noResultsElement.classList.add('hidden');
                }
            }// Placeholder for functions that need to be created in Code.gs and protected with JWT
            // google.script.run.getClassrooms(currentToken);
            // google.script.run.getStudentsByClassroom(classroomId, currentToken);

        </script>
    </body>
</html>
