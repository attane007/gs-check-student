<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อการเข้าแถวตอนเช้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            pink: '#FFB3BA',
                            peach: '#FFDFBA',
                            yellow: '#FFFFBA',
                            green: '#BAFFC9',
                            blue: '#BAE1FF',
                            purple: '#E1BAFF',
                            lavender: '#F0E6FF',
                            mint: '#E6FFE6',
                            coral: '#FFE6E6',
                            sky: '#E6F3FF'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Kanit', sans-serif;
        }

        .glass-effect {
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }

        .blur-backdrop {
            backdrop-filter: blur(10px);
        }        .simple-hover:hover {
            opacity: 0.9;
        }        /* Status Button Styles */
        .status-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .status-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .status-btn:hover::before {
            left: 100%;
        }

        .status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .status-btn:active {
            transform: translateY(0);
            transition: transform 0.1s;
        }

        /* Present Button */
        .status-btn.present {
            background: linear-gradient(135deg, rgba(186, 255, 201, 0.6), rgba(230, 255, 230, 0.6));
            color: #065f46;
            border-color: rgba(16, 185, 129, 0.3);
        }
        .status-btn.present.active {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            border-color: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            transform: scale(1.1);
        }
        .status-btn.present:hover:not(.active) {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.8), rgba(52, 211, 153, 0.8));
            color: white;
        }

        /* Absent Button */
        .status-btn.absent {
            background: linear-gradient(135deg, rgba(255, 179, 186, 0.6), rgba(255, 230, 230, 0.6));
            color: #7f1d1d;
            border-color: rgba(239, 68, 68, 0.3);
        }
        .status-btn.absent.active {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            border-color: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            transform: scale(1.1);
        }
        .status-btn.absent:hover:not(.active) {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8), rgba(248, 113, 113, 0.8));
            color: white;
        }

        /* Late Button */
        .status-btn.late {
            background: linear-gradient(135deg, rgba(255, 255, 186, 0.6), rgba(255, 223, 186, 0.6));
            color: #92400e;
            border-color: rgba(245, 158, 11, 0.3);
        }
        .status-btn.late.active {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
            border-color: #d97706;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            transform: scale(1.1);
        }
        .status-btn.late:hover:not(.active) {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.8), rgba(251, 191, 36, 0.8));
            color: white;
        }

        /* Excused Button */
        .status-btn.excused {
            background: linear-gradient(135deg, rgba(186, 225, 255, 0.6), rgba(230, 243, 255, 0.6));
            color: #1e3a8a;
            border-color: rgba(59, 130, 246, 0.3);
        }
        .status-btn.excused.active {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transform: scale(1.1);
        }
        .status-btn.excused:hover:not(.active) {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(96, 165, 250, 0.8));
            color: white;
        }

        /* Pulse animation for active buttons */
        .status-btn.active {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            }
            50% {
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.6);
            }
            100% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            }
        }

        .hidden {
            display: none;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .animate-gradient {
            animation: gradient 3s linear infinite;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-pastel-pink via-pastel-peach to-pastel-yellow">
    <!-- Authentication Message Area -->
    <div id="authMessageArea" class="hidden fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center p-8 bg-white shadow-lg rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Authentication Required</h2>
            <p id="authMessageText" class="text-gray-600 mb-6">You need to be logged in to access this page.</p>
            <a id="authLoginLink" href="#"
                class="bg-pastel-purple text-white font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                Go to Login
            </a>
        </div>
    </div>

    <!-- Main Content Wrapper (initially hidden if auth message is shown) -->
    <div id="mainContentWrapper">
        <!-- Header -->
        <header class="glass-effect blur-backdrop border-b border-white/20 sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-12 h-12 bg-gradient-to-r from-pastel-purple to-pastel-blue rounded-full flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ระบบเช็คชื่อการเข้าแถวตอนเช้า</h1>
                            <p class="text-sm text-gray-600" id="currentDateTime"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Navigation -->
                        <div class="flex space-x-2">
                            <a href="#" id="navIndexLink" onclick="navigateTo('index')"
                                class="px-4 py-2 rounded-lg font-semibold bg-pastel-green text-gray-800">
                                <i class="fas fa-check-circle mr-1"></i>
                                เช็คชื่อ
                            </a>
                            <a href="#" id="navDashboardLink" onclick="navigateTo('dashboard')"
                                class="px-4 py-2 rounded-lg font-semibold bg-white/50 text-gray-600 hover:bg-white/70">
                                <i class="fas fa-chart-pie mr-1"></i>
                                Dashboard
                            </a> <a href="#" id="navSearchLink" onclick="navigateTo('search')"
                                class="px-4 py-2 rounded-lg font-semibold bg-white/50 text-gray-600 hover:bg-white/70 hidden">
                                <i class="fas fa-search mr-1"></i>
                                ค้นหา
                            </a>
                        </div>
                        <div id="userInfoDisplay" class="text-sm text-gray-700"></div>
                        <button id="logoutButton"
                            class="px-4 py-2 rounded-lg font-semibold bg-pastel-coral text-gray-800 hover:opacity-90 hidden">
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            ออกจากระบบ
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8">
            <!-- Attendance Section -->
            <div id="attendanceSection" class="grid lg:grid-cols-3 gap-8 items-start">
                <!-- Check-in Panel -->
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-2xl p-8 simple-hover h-fit">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">เช็คชื่อนักเรียน</h2>
                            <p class="text-gray-600">เลือกห้องเรียนเพื่อแสดงรายชื่อนักเรียน</p>
                        </div> <!-- Date and Classroom Selection -->
                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <!-- Date Selection -->
                            <div>
                                <label class="block text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-calendar-alt text-pastel-coral mr-2"></i>
                                    เลือกวันที่
                                </label>
                                <input type="date" id="attendanceDate"
                                    class="w-full px-6 py-4 text-lg border-2 border-pastel-blue/50 rounded-xl focus:border-pastel-purple focus:outline-none bg-white/90"
                                    onchange="onDateChange()">
                            </div>

                            <!-- Classroom Selection -->
                            <div>
                                <label class="block text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-door-open text-pastel-purple mr-2"></i>
                                    เลือกห้องเรียน
                                </label>
                                <div class="relative">
                                    <select id="classroomSelect"
                                        class="w-full px-6 py-4 text-lg border-2 border-pastel-blue/50 rounded-xl focus:border-pastel-purple focus:outline-none bg-white/90 appearance-none"
                                        onchange="loadClassroomStudents()">
                                        <option value="">-- เลือกห้องเรียน --</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Date Info Display -->
                        <div id="dateInfoDisplay"
                            class="mb-6 p-4 bg-gradient-to-r from-pastel-blue/20 to-pastel-sky/20 rounded-lg border border-pastel-blue/30 hidden">
                            <p class="text-sm text-gray-700 flex items-center">
                                <i class="fas fa-info-circle text-pastel-blue mr-2"></i>
                                <span id="selectedDateText"></span>
                            </p>
                        </div>

                        <!-- Students List -->
                        <div id="studentsListContainer" class="hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-users text-pastel-purple mr-2"></i>
                                    รายชื่อนักเรียน
                                </h3>
                                <div class="flex space-x-3">
                                    <button onclick="markAllPresent()"
                                        class="bg-gradient-to-r from-pastel-green to-pastel-mint text-gray-800 font-semibold py-2 px-5 rounded-xl hover:shadow-lg transition-all duration-200 text-sm">
                                        <i class="fas fa-check-double mr-1"></i>
                                        เข้าแถวทั้งหมด
                                    </button>
                                    <button onclick="markAllAbsent()"
                                        class="bg-gradient-to-r from-pastel-coral to-pastel-pink text-gray-800 font-semibold py-2 px-5 rounded-xl hover:shadow-lg transition-all duration-200 text-sm">
                                        <i class="fas fa-times-circle mr-1"></i>
                                        ไม่เข้าแถวทั้งหมด
                                    </button>
                                </div>
                            </div>

                            <!-- Student Search Box -->
                            <div class="mb-4 relative">
                                <input id="studentSearch" type="text" placeholder="ค้นหาชื่อนักเรียน..."
                                    class="w-full px-4 py-3 pr-10 border-2 border-pastel-blue/20 rounded-xl focus:border-pastel-purple focus:outline-none bg-white/80"
                                    oninput="filterStudents()">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>                            <!-- Legend for attendance status -->
                            <div class="flex flex-wrap justify-center gap-4 mb-6 text-sm">
                                <div class="flex items-center bg-white/50 px-3 py-2 rounded-lg">
                                    <span class="inline-block w-4 h-4 rounded-full bg-gradient-to-r from-green-400 to-green-500 mr-2 shadow-sm"></span>
                                    <span class="font-medium text-green-700">เข้าแถว</span>
                                </div>
                                <div class="flex items-center bg-white/50 px-3 py-2 rounded-lg">
                                    <span class="inline-block w-4 h-4 rounded-full bg-gradient-to-r from-red-400 to-red-500 mr-2 shadow-sm"></span>
                                    <span class="font-medium text-red-700">ไม่เข้าแถว</span>
                                </div>
                                <div class="flex items-center bg-white/50 px-3 py-2 rounded-lg">
                                    <span class="inline-block w-4 h-4 rounded-full bg-gradient-to-r from-yellow-400 to-yellow-500 mr-2 shadow-sm"></span>
                                    <span class="font-medium text-yellow-700">มาสาย</span>
                                </div>
                                <div class="flex items-center bg-white/50 px-3 py-2 rounded-lg">
                                    <span class="inline-block w-4 h-4 rounded-full bg-gradient-to-r from-blue-400 to-blue-500 mr-2 shadow-sm"></span>
                                    <span class="font-medium text-blue-700">ลา</span>
                                </div>
                            </div>
                            <div id="studentsList" class="space-y-2">
                                <!-- Students will be loaded here -->
                            </div>
                            <!-- No results message -->
                            <div id="noStudentsFound" class="hidden text-center py-6 text-gray-500">
                                <i class="fas fa-search text-3xl mb-2 text-gray-400"></i>
                                <p>ไม่พบนักเรียนที่ค้นหา</p>
                            </div>

                            <!-- Submit Section -->
                            <div class="mt-6 p-4 bg-gray-50 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div id="attendanceStats" class="text-gray-700">
                                        <span class="text-sm">สถิติการเข้าเรียน: </span>
                                        <span class="font-semibold text-green-600">มา: <span
                                                id="presentCount">0</span></span>
                                        <span class="mx-2">|</span>
                                        <span class="font-semibold text-red-500">ขาด: <span
                                                id="absentCount">0</span></span>
                                        <span class="mx-2">|</span>
                                        <span class="font-semibold text-orange-500">สาย: <span
                                                id="lateCount">0</span></span>
                                        <span class="mx-2">|</span>
                                        <span class="font-semibold text-blue-500">ลา: <span
                                                id="excusedCount">0</span></span>
                                    </div>
                                    <button id="submitAttendance" onclick="submitAttendance()"
                                        class="relative bg-gradient-to-r from-indigo-600 via-purple-600 to-purple-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg border-2 border-white/30 hover:scale-102 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed group"
                                        style="text-shadow: 1px 1px 2px rgba(0,0,0,0.2);"
                                        disabled>
                                        <span class="absolute inset-0 bg-white/10 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></span>
                                        <i class="fas fa-save mr-2"></i>
                                        บันทึกการเข้าเรียน
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Result Display -->
                        <div id="resultDisplay" class="hidden mt-6 glass-effect rounded-2xl p-6 shadow-lg text-center">
                            <!-- Success content will be inserted here -->
                        </div>

                        <!-- Loading Indicator -->
                        <div id="loadingIndicator"
                            class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50">
                            <div class="glass-effect rounded-xl p-8 text-center">
                                <div class="mb-4 relative">
                                    <div
                                        class="w-16 h-16 border-4 border-pastel-purple border-t-transparent rounded-full animate-spin mx-auto">
                                    </div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <i class="fas fa-school text-pastel-purple text-sm"></i>
                                    </div>
                                </div>
                                <p id="loadingMessage" class="text-lg font-medium text-gray-700">กำลังประมวลผล...</p>
                                <p class="text-sm text-gray-500 mt-1">โปรดรอสักครู่</p>
                            </div>
                        </div>

                        <!-- Result Display -->
                        <div id="resultDisplay" class="hidden"></div>
                    </div>
                </div>
                <!-- Side Panel -->
                <div class="space-y-6"> <!-- Classroom Info Card -->
                    <div class="glass-effect rounded-2xl p-6 simple-hover">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chalkboard-teacher text-pastel-purple mr-2"></i>
                            ข้อมูลห้องเรียน
                        </h3>
                        <div id="classroomInfo" class="text-gray-600">
                            <div class="flex items-center justify-center h-48">
                                <div class="text-center">
                                    <div
                                        class="w-16 h-16 mx-auto mb-3 bg-pastel-blue/30 rounded-full flex items-center justify-center">
                                        <i class="fas fa-school text-2xl text-pastel-purple"></i>
                                    </div>
                                    <p class="text-gray-600">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="glass-effect rounded-2xl p-6 simple-hover">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-pastel-purple mr-2"></i>
                            สถิติการเข้าแถว
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">เข้าแถว</span>
                                <span class="text-2xl font-bold text-green-600" id="statsPresent">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ไม่เข้าแถว</span>
                                <span class="text-2xl font-bold text-red-500" id="statsAbsent">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ยังไม่บันทึก</span>
                                <span class="text-2xl font-bold text-gray-500" id="statsUnmarked">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="attendanceProgress"
                                    class="bg-gradient-to-r from-pastel-green to-pastel-mint h-3 rounded-full"
                                    style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 text-center">
                                เปอร์เซ็นต์การเข้าแถว: <span id="attendancePercentage" class="font-semibold">0%</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Modal (same as dashboard) -->
        <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="glass-effect blur-backdrop rounded-2xl p-8 m-4 max-w-md w-full text-center">
                <div
                    class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-300 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">เกิดข้อผิดพลาด</h3>
                <div id="errorContent" class="text-gray-700"></div>
                <button onclick="closeModalAndMaybeLogout()"
                    class="mt-6 bg-gradient-to-r from-pastel-coral to-pastel-pink text-gray-800 font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                    ปิด
                </button>
            </div>
        </div>

        <script>
            const appUrl = '<?!= appUrl ?>'; // Injected by Apps Script doGet
            let currentUser = null;
            let currentToken = localStorage.getItem('jwtToken'); // Initialize on script load, not just in DOMContentLoaded

            // For debugging
            console.log('Token initialized from localStorage:', currentToken ? 'Token exists' : 'No token found');            // Helper function for top-level navigation in Apps Script
            function triggerTopNavigation(url) {
                window.top.location.href = url; // Directly set the href for top-level navigation
            }

            // Wrap token checking and authentication logic in a self-executing function
            // to avoid "Illegal return statement" error
            (function checkAuthAndInitialize() {
                // Token already initialized globally, but we'll check it again here
                if (!currentToken) {
                    currentToken = localStorage.getItem('jwtToken');
                    console.log('Token re-checked in function:', currentToken ? 'Token exists' : 'No token found');                }                // Declare variables globally so they can be used outside the function
                window.storedUserInfo = localStorage.getItem('userInfo');
                window.mainContentWrapper = document.getElementById('mainContentWrapper');
                window.authMessageArea = document.getElementById('authMessageArea');
                const authLoginLink = document.getElementById('authLoginLink');

                if (!currentToken) {
                    // Instead of redirecting, show the auth message and hide main content
                    mainContentWrapper.classList.add('hidden');
                    authMessageArea.classList.remove('hidden');
                    const loginUrl = appUrl + '?page=login&infoMessage=' + encodeURIComponent('Please login to continue.');
                    authLoginLink.href = loginUrl;
                    // Ensure the link uses triggerTopNavigation if it needs to overcome sandbox issues for some reason,
                    // but a direct href to a top navigation should work if user clicks.
                    authLoginLink.onclick = function (e) {
                        e.preventDefault();
                        triggerTopNavigation(loginUrl);
                    };
                    return; // Now this return is inside a function
                }
                  // If token exists, hide auth message and show main content
                window.mainContentWrapper.classList.remove('hidden');
                window.authMessageArea.classList.add('hidden');
            })();

            // Use window.storedUserInfo instead of local variable
            if (window.storedUserInfo) {
                currentUser = JSON.parse(storedUserInfo);
                initializePage();
            } else {
                // If token exists but no user info, try to fetch it
                // This case might happen if user info wasn't stored properly or cleared
                setLoading(true, 'Verifying session...');
                google.script.run
                    .withSuccessHandler(function (response) {
                        setLoading(false);
                        if (response.success && response.user) {
                            currentUser = response.user;
                            localStorage.setItem('userInfo', JSON.stringify(currentUser)); // Store it now
                            initializePage();
                        } else {
                            handleAuthError(response.error || 'Invalid session. Please login again.', response.expired);
                        }
                    })
                    .withFailureHandler(function (error) {
                        setLoading(false);
                        handleAuthError('Error verifying session: ' + error.message);
                    })
                    .getUserDataFromToken(currentToken);
            }                // Remove extra closing bracket

            function initializePage() {
                if (!currentUser) {
                    redirectToLogin('User data not available. Please login.');
                    return;
                }
                console.log('User authenticated:', currentUser.username, 'Role:', currentUser.role);

                // Set default date to today
                setDefaultDate();

                updateUserInfoDisplay();
                setupLogoutButton();
                setupNavigation();
                loadInitialData(); // For student lists, classrooms etc.
                updateDateTime();                setInterval(updateDateTime, 1000);
            }

            // Time and date display function
            function updateDateTime() {
                const now = new Date();
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                const dateTimeString = now.toLocaleString('th-TH', options);
                const dateTimeElement = document.getElementById('currentDateTime');
                if (dateTimeElement) {
                    dateTimeElement.textContent = dateTimeString;
                }
            }

            // Date handling functions
            function setDefaultDate() {
                const dateInput = document.getElementById('attendanceDate');
                if (dateInput) {
                    const today = new Date();
                    dateInput.value = formatDateForInput(today);
                    updateDateDisplay();
                }
            }

            function formatDateForInput(date) {
                return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            }

            function onDateChange() {
                const dateInput = document.getElementById('attendanceDate');
                const classroomSelect = document.getElementById('classroomSelect');
                  if (dateInput && dateInput.value) {
                    updateDateDisplay();
                    if (classroomSelect && classroomSelect.value) {
                        loadClassroomStudents(); // Load students for the new date
                    }
                } else {
                    hideDateDisplay();
                }
            }
            
            function hideDateDisplay() {
                const dateInfoDisplay = document.getElementById('dateInfoDisplay');
                if (dateInfoDisplay) {
                    dateInfoDisplay.classList.add('hidden');
                }
            }
              function hideStudentsList() {
                const studentsListContainer = document.getElementById('studentsListContainer');
                if (studentsListContainer) {
                    studentsListContainer.classList.add('hidden');
                }
            }
            
            function updateDateDisplay() {
                const dateInput = document.getElementById('attendanceDate');
                const dateInfoDisplay = document.getElementById('dateInfoDisplay');
                const selectedDateText = document.getElementById('selectedDateText');
                
                if (dateInput && dateInput.value && dateInfoDisplay && selectedDateText) {
                    const selectedDate = new Date(dateInput.value);
                    
                    // Format date in Thai
                    const thaiDate = selectedDate.toLocaleDateString('th-TH', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    selectedDateText.textContent = `เลือกวันที่: ${thaiDate}`;
                    dateInfoDisplay.classList.remove('hidden');
                }
            }

            function hideDateDisplay() {
                const dateInfoDisplay = document.getElementById('dateInfoDisplay');
                if (dateInfoDisplay) {
                    dateInfoDisplay.classList.add('hidden');
                }
            }function resetClassroomInfo() {
                const classroomInfo = document.getElementById('classroomInfo');
                if (classroomInfo) {
                    classroomInfo.innerHTML = `
                        <div class="flex items-center justify-center h-48">
                            <div class="text-center">
                                <div class="w-16 h-16 mx-auto mb-3 bg-pastel-blue/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-school text-2xl text-pastel-purple"></i>
                                </div>
                                <p class="text-gray-600">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</p>
                            </div>
                        </div>
                    `;
                }
                
                // Reset stats card as well
                resetStatsCard();
            }
            
            function resetStatsCard() {
                const statsPresentElement = document.getElementById('statsPresent');
                const statsAbsentElement = document.getElementById('statsAbsent');
                const statsUnmarkedElement = document.getElementById('statsUnmarked');
                const attendanceProgressElement = document.getElementById('attendanceProgress');
                const attendancePercentageElement = document.getElementById('attendancePercentage');
                
                if (statsPresentElement) statsPresentElement.textContent = '0';
                if (statsAbsentElement) statsAbsentElement.textContent = '0';
                if (statsUnmarkedElement) statsUnmarkedElement.textContent = '0';
                if (attendanceProgressElement) attendanceProgressElement.style.width = '0%';
                if (attendancePercentageElement) attendancePercentageElement.textContent = '0%';
            }

            function resetStats() {
                document.getElementById('statsPresent').textContent = '0';
                document.getElementById('statsAbsent').textContent = '0';
                document.getElementById('statsUnmarked').textContent = '0';
                document.getElementById('attendanceProgress').style.width = '0%';
                document.getElementById('attendancePercentage').textContent = '0%';
            }

            function updateUserInfoDisplay() {
                const userInfoDisplay = document.getElementById('userInfoDisplay');
                if (userInfoDisplay && currentUser) {
                    userInfoDisplay.textContent = `Welcome, ${currentUser.fullName} (${currentUser.role})`;
                }
            }

            function setupLogoutButton() {
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton) {
                    logoutButton.classList.remove('hidden');
                    logoutButton.addEventListener('click', function () {
                        setLoading(true, 'Logging out...');
                        // Optional: Call server-side logout for logging, though JWT logout is client-side primarily
                        google.script.run
                            .withSuccessHandler(function (response) {
                                // Regardless of server response, clear client-side token
                                localStorage.removeItem('jwtToken');
                                localStorage.removeItem('userInfo');
                                redirectToLogin('You have been logged out.');
                            })
                            .withFailureHandler(function (error) {
                                // Still clear client-side token even if server call fails
                                localStorage.removeItem('jwtToken');
                                localStorage.removeItem('userInfo');
                                redirectToLogin('Logout completed. Server notification failed.');
                            })
                            .logoutUser(currentToken); // Pass token if server needs it for blocklisting etc.
                    });
                }
            }

            function setupNavigation() {
                // Find navigation links
                const navIndexLink = document.getElementById('navIndexLink');
                const navDashboardLink = document.getElementById('navDashboardLink');
                const navSearchLink = document.getElementById('navSearchLink');
                
                // Setup click handlers if elements exist
                if (navIndexLink) {
                    navIndexLink.classList.remove('hidden');
                    navIndexLink.onclick = function(e) { 
                        e.preventDefault(); 
                        navigateTo('index'); 
                    };
                }
                
                if (navDashboardLink) {
                    navDashboardLink.classList.remove('hidden');
                    navDashboardLink.onclick = function(e) { 
                        e.preventDefault(); 
                        navigateTo('dashboard'); 
                    };
                }
                
                if (navSearchLink) {
                    navSearchLink.classList.remove('hidden');
                    navSearchLink.onclick = function(e) { 
                        e.preventDefault(); 
                        navigateTo('search'); 
                    };
                }
            }
            
            function navigateTo(page) {
                const url = appUrl + '?page=' + page;
                triggerTopNavigation(url);
            }

            function redirectToLogin(message) {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userInfo');
                let loginUrl = appUrl + '?page=login';
                if (message) {
                    loginUrl += '&infoMessage=' + encodeURIComponent(message);
                }
                // setTimeout removed as the main issue was initial load without user activation
                triggerTopNavigation(loginUrl);
            }

            function handleAuthError(errorMessage, isExpired) {
                console.error('Auth Error:', errorMessage); showErrorModal('Authentication Error: ' + errorMessage + (isExpired ? ' (Token Expired)' : ''), true);
                // The modal's close button will handle logout via closeModalAndMaybeLogout
            }

            function setLoading(isLoading, message = 'กำลังประมวลผล...') {
                const indicator = document.getElementById('loadingIndicator');
                const loadingMessage = document.getElementById('loadingMessage');

                if (indicator) {
                    if (isLoading) {
                        // Update message
                        if (loadingMessage) {
                            loadingMessage.textContent = message;
                        }

                        // Show loading with fade-in animation
                        document.body.classList.add('overflow-hidden'); // Prevent scrolling while loading
                        indicator.style.opacity = '0';
                        indicator.classList.remove('hidden');

                        setTimeout(() => {
                            indicator.style.transition = 'opacity 0.3s ease-in';
                            indicator.style.opacity = '1';
                        }, 10);

                    } else {
                        // Fade out animation
                        indicator.style.transition = 'opacity 0.3s ease-out';
                        indicator.style.opacity = '0';

                        setTimeout(() => {
                            indicator.classList.add('hidden');
                            document.body.classList.remove('overflow-hidden');
                            indicator.style.transition = '';
                            indicator.style.opacity = '1';
                        }, 300);
                    }
                }
            }            function loadInitialData() {
                setLoading(true, 'Loading initial data...');
                let classroomLoaded = false;
                let statsLoaded = false;
                let headersFixed = false;

                function checkAllLoaded() {
                    if (classroomLoaded && statsLoaded && headersFixed) {
                        setLoading(false);
                    }                }
                
                // Fix attendance headers first
                fixAttendanceHeaders()
                    .then(() => {
                        console.log('Attendance headers verified/updated');
                        headersFixed = true;
                        checkAllLoaded();
                    })
                    .catch((error) => {
                        console.warn('Header fix failed, continuing anyway:', error);
                        headersFixed = true;
                        checkAllLoaded();
                    });// Fetch classrooms data from Classrooms sheet
                google.script.run
                    .withSuccessHandler(function (response) {
                        classroomLoaded = true;
                        if (response.success && response.classrooms) {
                            populateClassroomDropdown(response.classrooms);
                        } else if (!response.success) {
                            handleAuthError(response.error || 'Failed to load classrooms.', response.expired);
                        }
                        checkAllLoaded();
                    }).withFailureHandler(function (error) {
                        classroomLoaded = true;
                        handleAuthError('Error loading classrooms: ' + error.message);
                        checkAllLoaded();
                    })
                    .getClassrooms(currentToken);

                // Fetch daily attendance stats
                console.log('About to call getDailyAttendanceStats with token:', currentToken ? 'Token exists' : 'No token!');
                if (!currentToken) {
                    console.warn('WARNING: Token is missing for getDailyAttendanceStats call! Trying to recover...');
                    currentToken = localStorage.getItem('jwtToken');
                    console.log('Recovery attempt result:', currentToken ? 'Token recovered' : 'Still no token');
                }

                google.script.run.withSuccessHandler(function (response) {
                    statsLoaded = true;
                    console.log('getDailyAttendanceStats response:', response);
                    if (response.success) {
                        if (response.totalPresentToday !== undefined) {
                            // Today count display removed from navbar
                        } else if (response.dailyStats && response.dailyStats.length > 0) {
                            // If we have daily stats, use them to calculate total present for today
                            const today = new Date();
                            const todayString = today.getFullYear() + '-' +
                                String(today.getMonth() + 1).padStart(2, '0') + '-' +
                                String(today.getDate()).padStart(2, '0');
                            const todayStat = response.dailyStats.find(stat => stat.date === todayString);
                            if (todayStat) {
                                // Data loaded successfully but display removed from navbar
                            } else {
                                console.warn('No stats found for today in dailyStats array');
                            }
                        } else {
                            console.warn('Daily attendance stats loaded successfully but data is missing.');
                        }
                    } else {
                        console.error('Failed to load daily attendance stats:', response.error || 'Unknown error');
                        if (response.expired) {
                            handleAuthError(response.error || 'Session expired while loading daily stats.', response.expired);
                        } else {
                            // Today count display removed from navbar
                        }
                    } checkAllLoaded();
                }).withFailureHandler(function (error) {
                    statsLoaded = true;
                    console.error('Error loading daily attendance stats:', error.message);
                    // Today count display removed from navbar
                    checkAllLoaded();
                })
                    .getDailyAttendanceStats(7, currentToken); // Pass days=7 as first parameter
            }            function populateClassroomDropdown(classrooms) {
                const classroomSelect = document.getElementById('classroomSelect');
                if (!classroomSelect) return;
                
                // Store classrooms data for later use
                classroomsData = classrooms;
                
                // Clear existing options except the first one (placeholder)
                while (classroomSelect.options.length > 1) {
                    classroomSelect.remove(1);
                }
                
                // Sort classrooms by name
                classrooms.sort((a, b) => {
                    if (a.name < b.name) return -1;
                    if (a.name > b.name) return 1;
                    return 0;
                });
                
                // Add new options
                classrooms.forEach(classroom => {
                    const option = document.createElement('option');
                    option.value = classroom.id;
                    option.textContent = classroom.name;
                    classroomSelect.appendChild(option);
                });

                // Add change event listener
                classroomSelect.addEventListener('change', function() {
                    loadClassroomStudents();
                });
            }

            function loadClassroomStudents() {
                const classroomSelect = document.getElementById('classroomSelect');
                const dateInput = document.getElementById('attendanceDate');
                
                if (!classroomSelect || !dateInput) return;
                
                const selectedClassroom = classroomSelect.value;
                const selectedDate = dateInput.value;
                  if (!selectedClassroom || selectedClassroom === '') {
                    hideStudentsList();
                    resetClassroomInfo();
                    return;
                }
                
                if (!selectedDate) {
                    showError('Please select a date');
                    hideStudentsList();
                    return;
                }
                
                setLoading(true, `Loading students for classroom ${selectedClassroom}...`);
                
                // Get all students and filter by classroom, then get attendance for the date
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success && response.students) {
                            // Filter students by classroom
                            const classroomStudents = response.students.filter(student => 
                                student.classroom === selectedClassroom
                            );
                            
                            if (classroomStudents.length === 0) {
                                setLoading(false);
                                showError('No students found in this classroom');
                                hideStudentsList();
                                return;
                            }
                            
                            // Now get attendance data for this date and classroom
                            google.script.run
                                .withSuccessHandler(function(attendanceResponse) {
                                    setLoading(false);
                                    
                                    if (attendanceResponse.success) {
                                        // Show date display
                                        updateDateDisplay();
                                        
                                        // Render students with existing attendance data
                                        renderStudents(classroomStudents, attendanceResponse.attendance || []);
                                        
                                        // Show students list
                                        const studentsListContainer = document.getElementById('studentsListContainer');
                                        if (studentsListContainer) {
                                            studentsListContainer.classList.remove('hidden');
                                        }
                                          // Render students will trigger updateClassroomInfo via updateStats()
                                    } else {
                                        if (attendanceResponse.expired) {
                                            handleAuthError(attendanceResponse.error || 'Your session has expired', true);
                                        } else {
                                            // Still show students even if attendance data fails
                                            updateDateDisplay();
                                            renderStudents(classroomStudents, []);
                                            const studentsListContainer = document.getElementById('studentsListContainer');
                                            if (studentsListContainer) {
                                                studentsListContainer.classList.remove('hidden');
                                            }
                                        }
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    setLoading(false);
                                    // Show students even if attendance data fails
                                    updateDateDisplay();
                                    renderStudents(classroomStudents, []);
                                    const studentsListContainer = document.getElementById('studentsListContainer');
                                    if (studentsListContainer) {
                                        studentsListContainer.classList.remove('hidden');
                                    }
                                    updateClassroomInfo();
                                })
                                .getAttendanceByDate(selectedDate, currentToken);
                        } else {
                            setLoading(false);
                            if (response.expired) {
                                handleAuthError(response.error || 'Your session has expired', true);
                            } else {
                                showError(response.error || 'Failed to load students');
                                hideStudentsList();
                            }
                        }
                    })
                    .withFailureHandler(function(error) {
                        setLoading(false);
                        showError('Error loading students: ' + error.message);
                        hideStudentsList();
                    })
                    .getStudents(currentToken);
            }              function updateClassroomInfo() {
                const classroomSelect = document.getElementById('classroomSelect');
                const selectedClassroom = classroomSelect ? classroomSelect.value : '';
                
                if (!selectedClassroom || !currentStudents) return;
                
                // Find classroom name from stored data
                const classroomInfo = classroomsData.find(c => c.id === selectedClassroom);
                const classroomName = classroomInfo ? classroomInfo.name : selectedClassroom;
                
                // Filter students for selected classroom only
                const classroomStudents = currentStudents.filter(student => student.classroom === selectedClassroom);
                
                // Count attendance stats
                let total = classroomStudents.length;
                let present = 0;
                let absent = 0;
                let late = 0;
                let excused = 0;
                let unmarked = 0;
                
                // Only count attendance for students in this classroom
                classroomStudents.forEach(student => {
                    const status = attendanceStatus[student.id];
                    if (status === 'present') present++;
                    else if (status === 'absent') absent++;
                    else if (status === 'late') late++;
                    else if (status === 'excused') excused++;
                    else unmarked++;
                });
                
                unmarked = total - (present + absent + late + excused);
                
                // Update classroom info card
                const classroomInfoElement = document.getElementById('classroomInfo');
                if (classroomInfoElement) {
                    classroomInfoElement.innerHTML = `
                        <div class="space-y-4">
                            <div class="text-center p-4 bg-gradient-to-r from-pastel-blue/20 to-pastel-purple/20 rounded-lg">
                                <h4 class="text-lg font-semibold text-gray-800">${classroomName}</h4>
                                <p class="text-sm text-gray-600">รหัสห้อง: ${selectedClassroom}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div class="text-center p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${present}</div>
                                    <div class="text-gray-600">เข้าแถว</div>
                                </div>
                                <div class="text-center p-3 bg-red-50 rounded-lg">
                                    <div class="text-2xl font-bold text-red-600">${absent}</div>
                                    <div class="text-gray-600">ไม่เข้าแถว</div>
                                </div>
                                <div class="text-center p-3 bg-yellow-50 rounded-lg">
                                    <div class="text-2xl font-bold text-yellow-600">${late}</div>
                                    <div class="text-gray-600">มาสาย</div>
                                </div>
                                <div class="text-center p-3 bg-blue-50 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${excused}</div>
                                    <div class="text-gray-600">ลา</div>
                                </div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded-lg">
                                <div class="text-lg font-semibold text-gray-700">นักเรียนทั้งหมด: ${total} คน</div>
                            </div>
                        </div>
                    `;
                }
                
                // Update stats card
                updateStatsCard(total, present, absent, late, excused, unmarked);
                
                console.log(`Classroom ${classroomName} (${selectedClassroom}): Total=${total}, Present=${present}, Absent=${absent}, Late=${late}, Excused=${excused}, Unmarked=${unmarked}`);
            }
            
            function updateStatsCard(total, present, absent, late, excused, unmarked) {
                // Update individual stats
                const statsPresentElement = document.getElementById('statsPresent');
                const statsAbsentElement = document.getElementById('statsAbsent');
                const statsUnmarkedElement = document.getElementById('statsUnmarked');
                const attendanceProgressElement = document.getElementById('attendanceProgress');
                const attendancePercentageElement = document.getElementById('attendancePercentage');
                
                if (statsPresentElement) statsPresentElement.textContent = present;
                if (statsAbsentElement) statsAbsentElement.textContent = absent;
                if (statsUnmarkedElement) statsUnmarkedElement.textContent = unmarked;
                
                // Calculate and update percentage
                const attendedCount = present + late; // นับมาสายเป็นมา
                const percentage = total > 0 ? Math.round((attendedCount / total) * 100) : 0;
                
                if (attendanceProgressElement) {
                    attendanceProgressElement.style.width = `${percentage}%`;
                }
                
                if (attendancePercentageElement) {
                    attendancePercentageElement.textContent = `${percentage}%`;
                }
            }let currentStudents = [];
            let attendanceStatus = {};
            let classroomsData = []; // Store classroom data for name lookup
            
            function renderStudents(students, existingAttendance) {
                const studentsList = document.getElementById('studentsList');
                if (!studentsList) return;
                
                // Clear previous list
                studentsList.innerHTML = '';
                
                // Save current students data
                currentStudents = students;
                attendanceStatus = {};
                
                // Process existing attendance if available
                if (existingAttendance && Array.isArray(existingAttendance)) {
                    existingAttendance.forEach(record => {
                        if (record.studentId) {
                            attendanceStatus[record.studentId] = record.status;
                        }
                    });
                }
                
                if (students.length === 0) {
                    studentsList.innerHTML = `
                        <div class="text-center py-8">
                            <div class="w-16 h-16 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-slash text-2xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-500">ไม่พบนักเรียนในห้องเรียนนี้</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort students by name
                students.sort((a, b) => {
                    if (a.firstName < b.firstName) return -1;
                    if (a.firstName > b.firstName) return 1;
                    return 0;
                });
                
                // Render student cards
                students.forEach(student => {
                    const status = attendanceStatus[student.id] || '';
                    const card = document.createElement('div');
                    card.className = 'student-item glass-effect p-4 rounded-xl';
                    
                    card.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-medium text-gray-800">${student.firstName} ${student.lastName}</h4>
                                <p class="text-sm text-gray-600">${student.id}</p>
                            </div>                            <div class="flex space-x-2">
                                <button onclick="markStudent('${student.id}', 'present')" 
                                    class="status-btn present ${status === 'present' ? 'active' : ''} w-12 h-12 rounded-full flex flex-col items-center justify-center transition-all duration-300"
                                    title="เข้าแถว">
                                    <i class="fas fa-check text-lg"></i>
                                </button>
                                <button onclick="markStudent('${student.id}', 'absent')" 
                                    class="status-btn absent ${status === 'absent' ? 'active' : ''} w-12 h-12 rounded-full flex flex-col items-center justify-center transition-all duration-300"
                                    title="ไม่เข้าแถว">
                                    <i class="fas fa-times text-lg"></i>
                                </button>
                                <button onclick="markStudent('${student.id}', 'late')" 
                                    class="status-btn late ${status === 'late' ? 'active' : ''} w-12 h-12 rounded-full flex flex-col items-center justify-center transition-all duration-300"
                                    title="มาสาย">
                                    <i class="fas fa-clock text-lg"></i>
                                </button>
                                <button onclick="markStudent('${student.id}', 'excused')" 
                                    class="status-btn excused ${status === 'excused' ? 'active' : ''} w-12 h-12 rounded-full flex flex-col items-center justify-center transition-all duration-300"
                                    title="ลา">
                                    <i class="fas fa-calendar-check text-lg"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    studentsList.appendChild(card);
                });
                
                updateStats();
            }
            
            function markStudent(studentId, status) {
                // Update attendance status
                attendanceStatus[studentId] = status;
                
                // Update display status
                const buttons = document.querySelectorAll(`button[onclick*="markStudent('${studentId}')"]`);
                buttons.forEach(button => {
                    if (button.classList.contains(status)) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
                
                // Update stats
                updateClassroomInfo();
                updateSubmitButton();
                // Toggle status if already selected
                if (attendanceStatus[studentId] === status) {
                    delete attendanceStatus[studentId];
                } else {
                    attendanceStatus[studentId] = status;
                }
                
                // Update UI
                const statusButtons = document.querySelectorAll(`.student-item button[onclick*="${studentId}"]`);
                statusButtons.forEach(button => {
                    button.classList.remove('active');
                    if (button.classList.contains(status) && attendanceStatus[studentId] === status) {
                        button.classList.add('active');
                    }
                });
                
                updateStats();
                updateSubmitButton();
            }
            
            function markAllPresent() {
                currentStudents.forEach(student => {
                    attendanceStatus[student.id] = 'present';
                });
                updateAllStudentButtons();
            }
            
            function markAllAbsent() {
                currentStudents.forEach(student => {
                    attendanceStatus[student.id] = 'absent';
                });
                updateAllStudentButtons();
            }
            
            function updateAllStudentButtons() {
                const statusButtons = document.querySelectorAll('.student-item button');
                statusButtons.forEach(button => {
                    button.classList.remove('active');
                    
                    const studentId = button.getAttribute('onclick').split("'")[1];
                    const studentStatus = attendanceStatus[studentId];
                    
                    if (button.classList.contains(studentStatus)) {
                        button.classList.add('active');
                    }
                });
                
                updateStats();
                updateSubmitButton();
            }
              function updateStats() {
                const presentCount = Object.values(attendanceStatus).filter(status => status === 'present').length;
                const absentCount = Object.values(attendanceStatus).filter(status => status === 'absent').length;
                const lateCount = Object.values(attendanceStatus).filter(status => status === 'late').length;
                const excusedCount = Object.values(attendanceStatus).filter(status => status === 'excused').length;
                const unmarkedCount = currentStudents.length - Object.keys(attendanceStatus).length;
                const totalStudents = currentStudents.length;
                
                // Update stats card using the helper function
                updateStatsCard(totalStudents, presentCount, absentCount, lateCount, excusedCount, unmarkedCount);
                
                // Also update classroom info
                updateClassroomInfo();
            }
            
            function updateSubmitButton() {
                const submitButton = document.getElementById('submitAttendance');
                const hasAnyStatus = Object.keys(attendanceStatus).length > 0;
                
                if (submitButton) {
                    submitButton.disabled = !hasAnyStatus;
                }
            }
            
            function submitAttendance() {
                const attendanceDateInput = document.getElementById('attendanceDate');
                const selectedDate = attendanceDateInput.value;
                
                if (!selectedDate) {
                    alert('กรุณาเลือกวันที่');
                    return;
                }
                
                if (Object.keys(attendanceStatus).length === 0) {
                    alert('กรุณาเลือกสถานะการเข้าเรียนอย่างน้อย 1 คน');
                    return;
                }
                  setLoading(true, 'กำลังตรวจสอบระบบ...');
                
                // First, try to fix attendance headers if needed
                fixAttendanceHeaders()
                    .then(() => {
                        setLoading(true, 'กำลังบันทึกการเข้าเรียน...');
                        
                        google.script.run
                            .withSuccessHandler(function(response) {
                                setLoading(false);
                                if (response.success) {
                                    showSuccessResult(response);
                                } else {
                                    handleAuthError(response.message, response.expired);
                                }
                            })
                            .withFailureHandler(function(error) {
                                setLoading(false);
                                showErrorModal('เกิดข้อผิดพลาดในการบันทึก: ' + error.message);
                            })
                            .recordBulkAttendanceWithDate(attendanceStatus, selectedDate, currentToken);
                    })
                    .catch((error) => {
                        // If header fix fails, try to proceed anyway
                        console.warn('Header fix failed, proceeding with attendance submission:', error);
                        setLoading(true, 'กำลังบันทึกการเข้าเรียน...');
                        
                        google.script.run
                            .withSuccessHandler(function(response) {
                                setLoading(false);
                                if (response.success) {
                                    showSuccessResult(response);
                                } else {
                                    handleAuthError(response.message, response.expired);
                                }
                            })
                            .withFailureHandler(function(error) {
                                setLoading(false);
                                showErrorModal('เกิดข้อผิดพลาดในการบันทึก: ' + error.message);
                            })
                            .recordBulkAttendanceWithDate(attendanceStatus, selectedDate, currentToken);
                    });
            }
            
            function showSuccessResult(response) {
                const resultDisplay = document.getElementById('resultDisplay');
                const studentsListContainer = document.getElementById('studentsListContainer');
                
                if (resultDisplay) {
                    resultDisplay.innerHTML = `
                        <div class="text-center">                            <div class="w-20 h-20 bg-gradient-to-r from-pastel-green to-emerald-300 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-check text-white text-3xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">บันทึกสำเร็จ!</h3>
                            <p class="text-gray-700 mb-6">${response.message}</p>
                        </div>
                    `;
                    resultDisplay.classList.remove('hidden');
                    studentsListContainer.classList.add('hidden');
                }
            }

            // Error handling functions
            function showError(message) {
                console.error('Error:', message);
                // Show error in a simple alert for now, can be enhanced with modal later
                alert('เกิดข้อผิดพลาด: ' + message);
            }
            
            function showErrorModal(message, isAuthError = false) {
                console.error('Error Modal:', message);
                
                // Create modal if it doesn't exist
                let modal = document.getElementById('errorModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'errorModal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md mx-4">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">เกิดข้อผิดพลาด</h3>
                            </div>
                            <p id="errorModalMessage" class="text-gray-600 mb-6"></p>
                            <div class="flex justify-end space-x-3">
                                <button id="errorModalClose" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-medium transition-colors">
                                    ปิด
                                </button>
                                <button id="errorModalLogout" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-colors hidden">
                                    ออกจากระบบ
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Add event listeners
                    modal.querySelector('#errorModalClose').addEventListener('click', () => {
                        hideErrorModal();
                    });
                    
                    modal.querySelector('#errorModalLogout').addEventListener('click', () => {
                        hideErrorModal();
                        logout();
                    });
                }
                
                // Update modal content
                const messageElement = modal.querySelector('#errorModalMessage');
                const logoutButton = modal.querySelector('#errorModalLogout');
                
                if (messageElement) {
                    messageElement.textContent = message;
                }
                
                if (logoutButton) {
                    if (isAuthError) {
                        logoutButton.classList.remove('hidden');
                    } else {
                        logoutButton.classList.add('hidden');
                    }
                }
                
                // Show modal
                modal.classList.remove('hidden');
            }
            
            function hideErrorModal() {
                const modal = document.getElementById('errorModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }
            
            function logout() {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userInfo');
                redirectToLogin('You have been logged out.');
            }

            // Function to fix attendance sheet headers if needed
            function fixAttendanceHeaders() {
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(function(response) {
                            if (response.success) {
                                console.log('Attendance headers check/update:', response.message);
                                resolve(response);
                            } else {
                                console.error('Failed to update attendance headers:', response.error);
                                reject(new Error(response.error));
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error checking attendance headers:', error.message);
                            reject(error);
                        })
                        .updateAttendanceSheetHeaders();
                });
            }
        </script>
</body>

</html>