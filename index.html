<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อนักเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            pink: '#FFB3BA',
                            peach: '#FFDFBA',
                            yellow: '#FFFFBA',
                            green: '#BAFFC9',
                            blue: '#BAE1FF',
                            purple: '#E1BAFF',
                            lavender: '#F0E6FF',
                            mint: '#E6FFE6',
                            coral: '#FFE6E6',
                            sky: '#E6F3FF'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
        }
        .glass-effect {
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .blur-backdrop {
            backdrop-filter: blur(10px);
        }
        .simple-hover:hover {
            opacity: 0.9;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pastel-pink via-pastel-peach to-pastel-yellow">
    <!-- Authentication Message Area -->
    <div id="authMessageArea" class="hidden fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center p-8 bg-white shadow-lg rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Authentication Required</h2>
            <p id="authMessageText" class="text-gray-600 mb-6">You need to be logged in to access this page.</p>
            <a id="authLoginLink" href="#" class="bg-pastel-purple text-white font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                Go to Login
            </a>
        </div>
    </div>

    <!-- Main Content Wrapper (initially hidden if auth message is shown) -->
    <div id="mainContentWrapper">
        <!-- Header -->
        <header class="glass-effect blur-backdrop border-b border-white/20 sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-gradient-to-r from-pastel-purple to-pastel-blue rounded-full flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ระบบเช็คชื่อนักเรียน</h1>
                            <p class="text-sm text-gray-600" id="currentDateTime"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Navigation -->
                        <div class="flex space-x-2">
                            <a 
                                href="#" 
                                id="navIndexLink"
                                onclick="navigateTo('index')" 
                                class="px-4 py-2 rounded-lg font-semibold bg-pastel-green text-gray-800"
                            >
                                <i class="fas fa-check-circle mr-1"></i>
                                เช็คชื่อ
                            </a>
                            <a 
                                href="#" 
                                id="navDashboardLink"
                                onclick="navigateTo('dashboard')" 
                                class="px-4 py-2 rounded-lg font-semibold bg-white/50 text-gray-600 hover:bg-white/70"
                            >
                                <i class="fas fa-chart-pie mr-1"></i>
                                Dashboard
                            </a>
                        </div>
                        <div id="userInfoDisplay" class="text-sm text-gray-700"></div>
                        <button 
                            id="logoutButton"
                            class="px-4 py-2 rounded-lg font-semibold bg-pastel-coral text-gray-800 hover:opacity-90 hidden"
                        >
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            ออกจากระบบ
                        </button>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">นักเรียนที่เข้าเรียนวันนี้</p>
                            <p class="text-2xl font-bold text-pastel-purple" id="todayCount">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8">
            <!-- Attendance Section -->
            <div id="attendanceSection" class="grid lg:grid-cols-3 gap-8">
                <!-- Check-in Panel -->
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-2xl p-8 simple-hover">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">เช็คชื่อนักเรียน</h2>
                            <p class="text-gray-600">เลือกห้องเรียนเพื่อแสดงรายชื่อนักเรียน</p>
                        </div>

                        <!-- Classroom Selection -->
                        <div class="mb-8">
                            <label class="block text-sm font-medium text-gray-700 mb-2">เลือกห้องเรียน</label>
                            <select 
                                id="classroomSelect" 
                                class="w-full px-6 py-4 text-lg border-2 border-pastel-blue/50 rounded-xl focus:border-pastel-purple focus:outline-none bg-white/90"
                                onchange="loadClassroomStudents()"
                            >
                                <option value="">-- เลือกห้องเรียน --</option>
                            </select>
                        </div>

                        <!-- Students List -->
                        <div id="studentsListContainer" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800">รายชื่อนักเรียน</h3>
                                <div class="flex space-x-2">
                                    <button 
                                        onclick="markAllPresent()" 
                                        class="bg-gradient-to-r from-pastel-green to-pastel-mint text-gray-800 font-semibold py-2 px-4 rounded-lg hover:opacity-90 simple-hover text-sm"
                                    >
                                        <i class="fas fa-check-double mr-1"></i>
                                        เข้าเรียนทั้งหมด
                                    </button>
                                    <button 
                                        onclick="markAllAbsent()" 
                                        class="bg-gradient-to-r from-pastel-coral to-pastel-pink text-gray-800 font-semibold py-2 px-4 rounded-lg hover:opacity-90 simple-hover text-sm"
                                    >
                                        <i class="fas fa-times-circle mr-1"></i>
                                        ขาดเรียนทั้งหมด
                                    </button>
                                </div>
                            </div>
                            
                            <div id="studentsList" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Students will be loaded here -->
                            </div>
                        </div>

                        <!-- Loading Indicator -->
                        <div id="loadingIndicator" class="hidden text-center py-4">
                            <div class="inline-flex items-center space-x-2">
                                <div class="w-6 h-6 border-4 border-pastel-purple border-t-transparent rounded-full animate-spin"></div>
                                <span class="text-gray-600">กำลังประมวลผล...</span>
                            </div>
                        </div>

                        <!-- Result Display -->
                        <div id="resultDisplay" class="hidden"></div>
                    </div>
                </div>
                <!-- Side Panel -->
                <div class="space-y-6">
                    <!-- Classroom Info Card -->
                    <div class="glass-effect rounded-2xl p-6 simple-hover">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chalkboard-teacher text-pastel-purple mr-2"></i>
                            ข้อมูลห้องเรียน
                        </h3>
                        <div id="classroomInfo" class="text-gray-600">
                            <p class="text-center py-8">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</p>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="glass-effect rounded-2xl p-6 simple-hover">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-pastel-purple mr-2"></i>
                            สถิติการเข้าเรียน
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">มาเรียน</span>
                                <span class="text-2xl font-bold text-pastel-green" id="statsPresent">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ขาดเรียน</span>
                                <span class="text-2xl font-bold text-red-400" id="statsAbsent">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ยังไม่บันทึก</span>
                                <span class="text-2xl font-bold text-gray-400" id="statsUnmarked">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="attendanceProgress" class="bg-gradient-to-r from-pastel-green to-pastel-mint h-3 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 text-center">
                                เปอร์เซ็นต์การเข้าเรียน: <span id="attendancePercentage" class="font-semibold">0%</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Modal (same as dashboard) -->
        <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="glass-effect blur-backdrop rounded-2xl p-8 m-4 max-w-md w-full text-center">
                <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-300 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">เกิดข้อผิดพลาด</h3>
                <div id="errorContent" class="text-gray-700"></div>
                <button onclick="closeModalAndMaybeLogout()" class="mt-6 bg-gradient-to-r from-pastel-coral to-pastel-pink text-gray-800 font-semibold py-3 px-6 rounded-xl hover:opacity-90">
                    ปิด
                </button>
            </div>
        </div>

        <script>
            const appUrl = '<?!= appUrl ?>'; // Injected by Apps Script doGet
            let currentUser = null;
            let currentToken = null;

            // Helper function for top-level navigation in Apps Script
            function triggerTopNavigation(url) {
                window.top.location.href = url; // Directly set the href for top-level navigation
            }

            document.addEventListener('DOMContentLoaded', function() {
                currentToken = localStorage.getItem('jwtToken');
                const storedUserInfo = localStorage.getItem('userInfo');
                const mainContentWrapper = document.getElementById('mainContentWrapper');
                const authMessageArea = document.getElementById('authMessageArea');
                const authLoginLink = document.getElementById('authLoginLink');

                if (!currentToken) {
                    // Instead of redirecting, show the auth message and hide main content
                    mainContentWrapper.classList.add('hidden');
                    authMessageArea.classList.remove('hidden');
                    const loginUrl = appUrl + '?page=login&infoMessage=' + encodeURIComponent('Please login to continue.');
                    authLoginLink.href = loginUrl; 
                    // Ensure the link uses triggerTopNavigation if it needs to overcome sandbox issues for some reason,
                    // but a direct href to a top navigation should work if user clicks.
                    authLoginLink.onclick = function(e) { 
                        e.preventDefault(); 
                        triggerTopNavigation(loginUrl);
                    };
                    return; // Stop further execution
                }

                // If token exists, hide auth message and show main content
                mainContentWrapper.classList.remove('hidden');
                authMessageArea.classList.add('hidden');

                if (storedUserInfo) {
                    currentUser = JSON.parse(storedUserInfo);
                    initializePage();
                } else {
                    // If token exists but no user info, try to fetch it
                    // This case might happen if user info wasn't stored properly or cleared
                    setLoading(true, 'Verifying session...');
                    google.script.run
                        .withSuccessHandler(function(response) {
                            setLoading(false);
                            if (response.success && response.user) {
                                currentUser = response.user;
                                localStorage.setItem('userInfo', JSON.stringify(currentUser)); // Store it now
                                initializePage();
                            } else {
                                handleAuthError(response.error || 'Invalid session. Please login again.', response.expired);
                            }
                        })
                        .withFailureHandler(function(error) {
                            setLoading(false);
                            handleAuthError('Error verifying session: ' + error.message);
                        })
                        .getUserDataFromToken(currentToken);
                }
            });

            function initializePage() {
                if (!currentUser) {
                    redirectToLogin('User data not available. Please login.');
                    return;
                }
                console.log('User authenticated:', currentUser.username, 'Role:', currentUser.role);
                updateUserInfoDisplay();
                setupLogoutButton();
                setupNavigation();
                loadInitialData(); // For student lists, classrooms etc.
                updateDateTime();
                setInterval(updateDateTime, 1000);
            }

            function updateUserInfoDisplay() {
                const userInfoDisplay = document.getElementById('userInfoDisplay');
                if (userInfoDisplay && currentUser) {
                    userInfoDisplay.textContent = `Welcome, ${currentUser.fullName} (${currentUser.role})`;
                }
            }

            function setupLogoutButton() {
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton) {
                    logoutButton.classList.remove('hidden');
                    logoutButton.addEventListener('click', function() {
                        setLoading(true, 'Logging out...');
                        // Optional: Call server-side logout for logging, though JWT logout is client-side primarily
                        google.script.run
                            .withSuccessHandler(function(response) {
                                // Regardless of server response, clear client-side token
                                localStorage.removeItem('jwtToken');
                                localStorage.removeItem('userInfo');
                                redirectToLogin('You have been logged out.');
                            })
                            .withFailureHandler(function(error) {
                                // Still clear client-side token even if server call fails
                                localStorage.removeItem('jwtToken');
                                localStorage.removeItem('userInfo');
                                redirectToLogin('Logout completed. Server notification failed.');
                            })
                            .logoutUser(currentToken); // Pass token if server needs it for blocklisting etc.
                });
            }
        }

            function setupNavigation() {
                const navIndexLink = document.getElementById('navIndexLink');
                const navDashboardLink = document.getElementById('navDashboardLink');

                if (navIndexLink) {
                    navIndexLink.onclick = function(e) { e.preventDefault(); navigateTo('index'); };
                }
                if (navDashboardLink) {
                    navDashboardLink.onclick = function(e) { e.preventDefault(); navigateTo('dashboard'); };
                    // Show dashboard link only if admin/teacher
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'teacher')) {
                        navDashboardLink.classList.remove('hidden'); 
                    } else {
                        navDashboardLink.classList.add('hidden');
                    }
                }
            }
            
            function navigateTo(page) {
                // window.top.location.href = appUrl + '?page=' + page;
                triggerTopNavigation(appUrl + '?page=' + page);
            }

            function redirectToLogin(message) {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userInfo');
                let loginUrl = appUrl + '?page=login';
                if (message) {
                    loginUrl += '&infoMessage=' + encodeURIComponent(message);
                }
                // setTimeout removed as the main issue was initial load without user activation
                triggerTopNavigation(loginUrl);
            }

            function handleAuthError(errorMessage, isExpired) {
                console.error('Auth Error:', errorMessage);
                showErrorModal('Authentication Error: ' + errorMessage + (isExpired ? ' (Token Expired)' : ''), true);
                // The modal's close button will handle logout via closeModalAndMaybeLogout
            }

            function setLoading(isLoading, message = 'Loading...') {
                const indicator = document.getElementById('loadingIndicator'); // Assuming a global one or adapt
                if (indicator) {
                    const textSpan = indicator.querySelector('span');
                    if (textSpan) textSpan.textContent = message;
                    indicator.classList.toggle('hidden', !isLoading);
                }
            }

            function loadInitialData() {
                setLoading(true, 'Loading initial data...');
                let classroomLoaded = false;
                let statsLoaded = false;

                function checkAllLoaded() {
                    if (classroomLoaded && statsLoaded) {
                        setLoading(false);
                    }
                }

                // Fetch classrooms
                google.script.run
                    .withSuccessHandler(function(response) {
                        classroomLoaded = true;
                        if (response.success && response.classrooms) {
                            populateClassroomDropdown(response.classrooms);
                        } else if (!response.success) {
                            handleAuthError(response.error || 'Failed to load classrooms.', response.expired);
                        }
                        checkAllLoaded();
                    })
                    .withFailureHandler(function(error) {
                        classroomLoaded = true;
                        handleAuthError('Error loading classrooms: ' + error.message);
                        checkAllLoaded();
                    })
                    .getClassrooms(currentToken);

                // Fetch daily attendance stats for "todayCount"
                google.script.run
                    .withSuccessHandler(function(response) {
                        statsLoaded = true;
                        if (response.success && response.totalPresentToday !== undefined) {
                            document.getElementById('todayCount').textContent = response.totalPresentToday;
                        } else if (!response.success) {
                            console.error('Failed to load daily attendance stats:', response.error || 'Unknown error');
                            if(response.expired) {
                                handleAuthError(response.error || 'Session expired while loading daily stats.', response.expired);
                            } else {
                                document.getElementById('todayCount').textContent = '-'; // Indicate data unavailable
                            }
                        } else {
                             console.warn('Daily attendance stats loaded successfully but data is missing.');
                             document.getElementById('todayCount').textContent = '-';
                        }
                        checkAllLoaded();
                    })
                    .withFailureHandler(function(error) {
                        statsLoaded = true;
                        console.error('Error loading daily attendance stats:', error.message);
                        document.getElementById('todayCount').textContent = '-'; // Indicate data unavailable
                        checkAllLoaded();
                    })
                    .getDailyAttendanceStats(currentToken);
            }

            function populateClassroomDropdown(classrooms) {
                const select = document.getElementById('classroomSelect');
                if (!select) return;
                select.innerHTML = '<option value="">-- เลือกห้องเรียน --</option>'; // Clear existing
                classrooms.forEach(classroom => {
                    const option = document.createElement('option');
                    option.value = classroom.id; // Assuming classroom object has id and name
                    option.textContent = classroom.name;
                    select.appendChild(option);
                });
            }

            function loadClassroomStudents() {
                const classroomSelect = document.getElementById('classroomSelect');
                const selectedClassroomId = classroomSelect.value;
                const studentsListDiv = document.getElementById('studentsList');
                const studentsListContainer = document.getElementById('studentsListContainer');
                const resultDisplay = document.getElementById('resultDisplay');

                if (!selectedClassroomId) {
                    studentsListContainer.classList.add('hidden');
                    studentsListDiv.innerHTML = '';
                    updateStats([], {}); // Clear stats
                    return;
                }

                setLoading(true, 'Loading students...');
                resultDisplay.classList.add('hidden');
                resultDisplay.textContent = '';

                google.script.run
                    .withSuccessHandler(function(response) {
                        setLoading(false);
                        if (response.success && response.students) {
                            renderStudents(response.students);
                            studentsListContainer.classList.remove('hidden');
                        } else if (!response.success) {
                            handleAuthError(response.error || 'Failed to load students.', response.expired);
                            studentsListContainer.classList.add('hidden');
                        }
                    })
                    .withFailureHandler(function(error) {
                        setLoading(false);
                        handleAuthError('Error loading students: ' + error.message);
                        studentsListContainer.classList.add('hidden');
                    })
                    .getStudentsByClassroom(selectedClassroomId, currentToken); // Assuming this function exists and is protected
            }

            let currentStudents = []; // To keep track of students for the current classroom
            let attendanceStatus = {}; // studentId: 'present'/'absent'/'late'

            function renderStudents(students) {
                currentStudents = students;
                attendanceStatus = {}; // Reset status for new list
                const listDiv = document.getElementById('studentsList');
                listDiv.innerHTML = ''; // Clear previous list

                if (students.length === 0) {
                    listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No students found in this classroom.</p>';
                    updateStats(students, attendanceStatus);
                    return;
                }

                students.forEach(student => {
                    const studentId = student.id; // Assuming student object has id, firstName, lastName
                    attendanceStatus[studentId] = null; // Initially unmarked

                    const card = document.createElement('div');
                    card.className = 'student-card bg-white/80 p-3 rounded-lg shadow flex items-center justify-between transition-all duration-200';
                    card.id = `student-${studentId}`;

                    card.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-pastel-lavender flex items-center justify-center mr-3">
                                <i class="fas fa-user text-pastel-purple"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700">${student.firstName} ${student.lastName}</p>
                                <p class="text-xs text-gray-500">ID: ${studentId}</p>
                            </div>
                        </div>
                        <div class="student-actions space-x-1">
                            <button title="Present" onclick="markStudent('${studentId}', 'present')" class="action-btn bg-green-100 text-green-600 hover:bg-green-200"><i class="fas fa-check"></i></button>
                            <button title="Absent" onclick="markStudent('${studentId}', 'absent')" class="action-btn bg-red-100 text-red-600 hover:bg-red-200"><i class="fas fa-times"></i></button>
                            <button title="Late" onclick="markStudent('${studentId}', 'late')" class="action-btn bg-yellow-100 text-yellow-600 hover:bg-yellow-200"><i class="fas fa-clock"></i></button>
                            <button title="Excused" onclick="markStudent('${studentId}', 'excused')" class="action-btn bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fas fa-info-circle"></i></button>
                        </div>
                    `;
                    listDiv.appendChild(card);
                });
                updateStats(students, attendanceStatus);
            }

            function markStudent(studentId, status) {
                attendanceStatus[studentId] = status;
                const card = document.getElementById(`student-${studentId}`);
                const buttons = card.querySelectorAll('.action-btn');
                buttons.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-1', 'ring-green-500', 'ring-red-500', 'ring-yellow-500', 'ring-blue-500'));
                
                let targetButton;
                if (status === 'present') targetButton = card.querySelector('button[title="Present"]');
                else if (status === 'absent') targetButton = card.querySelector('button[title="Absent"]');
                else if (status === 'late') targetButton = card.querySelector('button[title="Late"]');
                else if (status === 'excused') targetButton = card.querySelector('button[title="Excused"]');

                if (targetButton) {
                    targetButton.classList.add('ring-2', 'ring-offset-1');
                    if (status === 'present') targetButton.classList.add('ring-green-500');
                    else if (status === 'absent') targetButton.classList.add('ring-red-500');
                    else if (status === 'late') targetButton.classList.add('ring-yellow-500');
                    else if (status === 'excused') targetButton.classList.add('ring-blue-500');
                }
                updateStats(currentStudents, attendanceStatus);
                
                // Call server to record this single attendance event
                setLoading(true, 'Recording attendance...');
                google.script.run
                    .withSuccessHandler(function(response) {
                        setLoading(false);
                        const resultDisplay = document.getElementById('resultDisplay');
                        resultDisplay.textContent = response.message;
                        resultDisplay.className = response.success ? 'text-green-600 p-2 text-sm' : 'text-red-600 p-2 text-sm';
                        resultDisplay.classList.remove('hidden');
                        setTimeout(() => resultDisplay.classList.add('hidden'), 3000);
                        
                        if (response.success) {
                            if (response.newTotalPresentToday !== undefined) {
                                document.getElementById('todayCount').textContent = response.newTotalPresentToday;
                            }
                        } else {
                             handleAuthError(response.message || 'Failed to record attendance.', response.expired);
                        }
                    })
                    .withFailureHandler(function(error) {
                        setLoading(false);
                        handleAuthError('Error recording attendance: ' + error.message);
                    })
                    .recordAttendance(studentId, status, currentToken);
            }

            function markAllPresent() {
                currentStudents.forEach(student => markStudent(student.id, 'present'));
                // Note: markStudent calls recordAttendance for each. For bulk, a different server fn might be better.
            }

            function markAllAbsent() {
                currentStudents.forEach(student => markStudent(student.id, 'absent'));
            }

            function updateStats(students, statuses) {
                let present = 0, absent = 0, late = 0, excused = 0, unmarked = 0;
                students.forEach(student => {
                    const status = statuses[student.id];
                    if (status === 'present') present++;
                    else if (status === 'absent') absent++;
                    else if (status === 'late') late++; // Late is also considered present for some counts
                    else if (status === 'excused') excused++;
                    else unmarked++;
                });

                document.getElementById('statsPresent').textContent = present + late; // Count late as present for this stat
                document.getElementById('statsAbsent').textContent = absent;
                document.getElementById('statsUnmarked').textContent = unmarked;

                const totalStudents = students.length;
                const markedStudents = totalStudents - unmarked;
                let attendanceRate = 0;
                if (markedStudents > 0) {
                    // Consider present and late as 'attended' for rate calculation
                    attendanceRate = ((present + late) / markedStudents) * 100;
                }
                
                const progressPercentage = totalStudents > 0 ? (markedStudents / totalStudents) * 100 : 0;
                document.getElementById('attendanceProgress').style.width = `${progressPercentage}%`;
                document.getElementById('attendancePercentage').textContent = `${attendanceRate.toFixed(0)}%`;
                
                // Update classroom info (example)
                const classroomSelect = document.getElementById('classroomSelect');
                const classroomInfoDiv = document.getElementById('classroomInfo');
                if (classroomSelect.value) {
                    classroomInfoDiv.innerHTML = `
                        <p><strong>ห้องเรียน:</strong> ${classroomSelect.options[classroomSelect.selectedIndex].text}</p>
                        <p><strong>จำนวนนักเรียน:</strong> ${totalStudents}</p>
                        <p><strong>มาเรียน (รวมสาย):</strong> ${present + late}</p>
                        <p><strong>ขาดเรียน:</strong> ${absent}</p>
                        <p><strong>ลา:</strong> ${excused}</p>
                    `;
                } else {
                    classroomInfoDiv.innerHTML = '<p class="text-center py-8">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</p>';
                }
            }

            function updateDateTime() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                document.getElementById('currentDateTime').textContent = now.toLocaleDateString('th-TH', options);
            }

            // --- Error Modal --- 
            function showErrorModal(message, isAuthError = false) {
                document.getElementById('errorContent').textContent = message;
                document.getElementById('errorModal').classList.remove('hidden');
                // Change button behavior if it's an auth error that requires logout
                const closeButton = document.getElementById('errorModal').querySelector('button');
                if (isAuthError) {
                    closeButton.onclick = function() { closeModalAndLogout(); };
                } else {
                    closeButton.onclick = function() { closeModal(); };
                }
            }

            function closeModal() {
                document.getElementById('errorModal').classList.add('hidden');
            }

            function closeModalAndLogout() {
                closeModal();
                redirectToLogin('Your session is no longer valid. Please login again.');
            }

            // Placeholder for functions that need to be created in Code.gs and protected with JWT
            // google.script.run.getClassrooms(currentToken);
            // google.script.run.getStudentsByClassroom(classroomId, currentToken);

        </script>
    </body>
</html>
